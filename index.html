<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AquaClim Prestige - Devis & Factures</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

</head>

<body>
<div class="container">

  <!-- EN-TÃŠTE -->
  <header class="header">
    <div class="header-inner">
      <img src="logo.png" alt="AquaClim Prestige" class="header-logo" />
      <div>
       <h1 class="js-company-name">AquaClim Prestige</h1>
<p class="subtitle js-company-subtitle">Entretien & DÃ©pannage - Climatisation & Piscine</p>
<p class="contact">
  <span class="js-company-legal">Le Blevennec LoÃ¯c</span> â€“
  <span class="js-company-address">2 avenue Cauvin, 06100 Nice</span><br>
  TÃ©l : <span class="js-company-phone">06 03 53 77 73</span> â€“
  Email : <span class="js-company-email">aquaclimprestige@gmail.com</span><br>
  SIRET : <strong class="js-company-siret">XXXXXXXXXXXXX</strong>
</p>

      </div>
    </div>
  </header>

  <!-- ONGLET DEVIS / FACTURES -->

<!-- ONGLET ACCUEIL / DEVIS / CONTRATS / FACTURES -->
<div class="top-nav no-print">
  <button id="tabHome" class="btn tab-btn active" onclick="showHome()">ğŸ  Accueil</button>
  <button id="tabDevis" class="btn tab-btn" onclick="openFromHome('devis')">ğŸ“„ Devis</button>
  <button id="tabContrats" class="btn tab-btn" onclick="openFromHome('contrat')">ğŸ“˜ Contrats</button>
  <button id="tabFactures" class="btn tab-btn" onclick="openFromHome('facture')">ğŸ’° Factures</button>
  <button id="tabAttest" class="btn tab-btn" onclick="showAttestations()">ğŸ“‘ Attestations</button>
  <button id="tabCA" class="btn tab-btn tab-btn-ca" onclick="openCA()">ğŸ“Š CA</button>
  <button id="tabSettings" class="btn tab-btn" onclick="showSettings()">âš™ï¸ ParamÃ¨tres</button>
</div>

<div id="offlineBadge" class="offline-badge" style="display:none;">
  Hors ligne â€“ donnÃ©es en local
</div>


<section id="homeView">

  <div class="dashboard">
    <h2 class="dashboard-title">Vue dâ€™ensemble</h2>

    <div class="dashboard-grid">

      <!-- ğŸ“„ Devis -->
      <div class="dash-card" id="dashDevis">
        <div class="dash-header">ğŸ“„ Devis</div>
        <div class="dash-stats">
          <p id="dashDevisCount">0 devis enregistrÃ©s</p>
          <p id="dashDevisStatus">â€“</p>
          <p id="dashDevisLast">Dernier devis : â€“</p>
        </div>
        <button class="dash-btn" onclick="openFromHome('devis')">Voir les devis</button>
      </div>

      <!-- ğŸ“˜ Contrats -->
      <div class="dash-card" id="dashContrats">
        <div class="dash-header">ğŸ“˜ Contrats</div>
        <div class="dash-stats">
          <p id="dashContractCount">0 contrats actifs</p>
          <p id="dashContractRenew">Ã€ renouveler : â€“</p>
        </div>
        <!-- âš ï¸ ICI : 'contrat' (singulier) -->
        <button class="dash-btn" onclick="openFromHome('contrat')">Voir les contrats</button>
      </div>

      <!-- ğŸ’° Factures -->
      <div class="dash-card" id="dashFactures">
        <div class="dash-header">ğŸ’° Factures</div>
        <div class="dash-stats">
          <p id="dashInvoiceCount">0 factures crÃ©Ã©es</p>
          <p id="dashInvoiceUnpaid">ImpayÃ©es : â€“</p>
          <p id="dashInvoiceAmount">Montant impayÃ© : â€“</p>
        </div>
        <!-- âš ï¸ ICI : 'facture' (singulier) -->
        <button class="dash-btn dash-btn-facture" onclick="openFromHome('facture')">Voir les factures</button>
      </div>

<!-- ğŸ“Š CHIFFRE D'AFFAIRES-->
 <div class="dash-card dash-card-ca">
        <div class="dash-card-header">
          <span class="dash-card-icon">ğŸ“Š</span>
          <div>
            <h3>Chiffre d'affaires</h3>
          </div>
        </div>

        <p id="dashCATotal">CA total : â€“</p>
        <p id="dashCAPaid" class="dash-sub">PayÃ© : â€“</p>
        <p id="dashCAUnpaid" class="dash-sub">ImpayÃ© : â€“</p>
        <p id="dashCAMonth" class="dash-sub">Mois en cours : â€“</p>
        <p id="dashTVAMicroBadge"
           class="dash-sub"
           style="display:none; font-weight:600; color:#b00020;">
          TVA activÃ©e (20 %)
        </p>

        <button class="dash-btn dash-btn-primary" onclick="openCAReport()">
          Voir le CA dÃ©taillÃ©
        </button>
      </div> <!-- fin .dash-card-ca -->

    </div> <!-- fin .dashboard-grid -->

    <!-- ğŸ©º Tableau Ã‰tat de santÃ© global -->
    <div class="card health-card">
      <h2 class="section-title">Ã‰tat de santÃ© global</h2>
      <table class="health-table">
        <thead>
          <tr>
            <th>CatÃ©gorie</th>
            <th>Statut</th>
            <th>DÃ©tail</th>
          </tr>
        </thead>
        <tbody>
          <tr id="healthRowFacturesLate">
            <td>Factures critiques</td>
            <td class="health-status">â€“</td>
            <td class="health-detail">â€“</td>
          </tr>

          <tr id="healthRowFacturesPending">
            <td>Factures en attente</td>
            <td class="health-status">â€“</td>
            <td class="health-detail">â€“</td>
          </tr>

          <tr id="healthRowDevis">
            <td>Devis</td>
            <td class="health-status">â€“</td>
            <td class="health-detail">â€“</td>
          </tr>

          <tr id="healthRowContrats">
            <td>Contrats</td>
            <td class="health-status">â€“</td>
            <td class="health-detail">â€“</td>
          </tr>
          <!-- Plus tard : ligne Agenda -->
        </tbody>
      </table>
    </div> <!-- fin .health-card -->

    <!-- ğŸ—“ï¸ Planning de la semaine -->
   <div class="card planning-card">
  <h2 class="section-title">Planning de la semaine</h2>

  <div class="planning-header">
    <button type="button" class="btn btn-secondary btn-small"
            onclick="changePlanningWeek(-1)">
      â† Semaine prÃ©cÃ©dente
    </button>

    <span id="planningWeekLabel" class="planning-week-label"></span>

    <button type="button" class="btn btn-secondary btn-small"
            onclick="changePlanningWeek(1)">
      Semaine suivante â†’
    </button>
  </div>

  <div id="planningGrid" class="planning-grid"></div>

  <!-- dÃ©tails du jour sÃ©lectionnÃ© -->
  <div id="planningDetails" class="planning-details hidden"></div>
</div>

</div> <!-- fin .dashboard -->
</section> <!-- fin #homeView -->

<section id="attestationView" class="hidden">
  <div class="card">
    <h2>ğŸ“‘ Attestations & Rapports</h2>

    <button class="btn btn-primary" onclick="openClimAttestationGenerator()">
      GÃ©nÃ©rer une attestation clim
    </button>

    <button class="btn btn-primary" onclick="openPiscineRapportGenerator()">
      GÃ©nÃ©rer un rapport dâ€™intervention
    </button>
  </div>

  <!-- ğŸ§¾ Historique des attestations -->
  <div class="card">
    <h3>Historique des attestations clim</h3>

    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Client</th>
          <th>Adresse</th>
          <th>UnitÃ©s</th>
          <th>Source</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="attestationsTableBody">
        <tr>
          <td colspan="6" class="no-docs-cell">
            Aucune attestation enregistrÃ©e pour le moment
          </td>
        </tr>
      </tbody>
    </table>
  </div>

<div class="card">
  <h3>Historique des rapports dâ€™intervention</h3>

  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Client</th>
        <th>Type</th>
        <th>Source</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rapportsTableBody">
      <tr>
        <td colspan="5" class="no-docs-cell">
          Aucun rapport enregistrÃ© pour le moment
        </td>
      </tr>
    </tbody>
  </table>
</div>

</section>

<!-- ================== PARAMÃˆTRES ENTREPRISE ================== -->
<section id="settingsView" class="hidden">
  <div class="card">
    <h2 class="section-title">ParamÃ¨tres de lâ€™entreprise</h2>
    <p style="margin-bottom:10px;">
      Ces informations seront utilisÃ©es pour lâ€™en-tÃªte, les devis, factures, contrats,
      attestations et coordonnÃ©es bancaires.
    </p>

    <div class="row">
      <div class="form-group">
        <label for="confCompanyName">Nom commercial</label>
        <input type="text" id="confCompanyName" />
      </div>
      <div class="form-group">
        <label for="confSubtitle">Sous-titre</label>
        <input type="text" id="confSubtitle" />
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label for="confLegalName">Nom lÃ©gal / gÃ©rant</label>
        <input type="text" id="confLegalName" />
      </div>
      <div class="form-group">
        <label for="confSiret">SIRET</label>
        <input type="text" id="confSiret" />
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label for="confAddress">Adresse</label>
        <input type="text" id="confAddress" />
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label for="confPhone">TÃ©lÃ©phone</label>
        <input type="text" id="confPhone" />
      </div>
      <div class="form-group">
        <label for="confEmail">Email</label>
        <input type="email" id="confEmail" />
      </div>
    </div>

    <hr style="margin:18px 0;">

    <h3 class="section-title">CoordonnÃ©es bancaires (RIB / IBAN)</h3>

    <div class="row">
      <div class="form-group">
        <label for="confRibHolder">Titulaire du compte</label>
        <input type="text" id="confRibHolder" />
      </div>
      <div class="form-group">
        <label for="confBankName">Banque</label>
        <input type="text" id="confBankName" />
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label for="confIban">IBAN</label>
        <input type="text" id="confIban" />
      </div>
      <div class="form-group">
        <label for="confBic">BIC</label>
        <input type="text" id="confBic" />
      </div>
    </div>

    <div class="actions no-print" style="margin-top:20px;">
      <button class="btn btn-primary" type="button" onclick="saveCompanySettingsFromForm()">
        ğŸ’¾ Enregistrer les paramÃ¨tres
      </button>
    </div>
  </div>
</section>





<div id="rapportPopup" class="popup-overlay hidden">
  <div class="popup">
    <h2>ğŸ“ Rapport dâ€™intervention</h2>

    <div class="rapport-header-grid">
      <div>
        <label>Nom du client</label>
        <input
  type="text"
  id="rapClientName"
  list="clientsList"
  autocomplete="off"
  onchange="onRapportClientNameChange()"
  onblur="onRapportClientNameChange()"
/>

      </div>

      <div>
        <label>Date dâ€™intervention</label>
        <input type="date" id="rapDate">
      </div>
    </div>

    <label>Adresse</label>
    <input type="text" id="rapClientAddress">

    <label>Type de rapport</label>
    <select id="rapportType" onchange="rebuildRapportChecklist()">
      <option value="">â€” Choisir â€”</option>
    </select>

    <div id="rapportChecklist" class="rapport-checklist"></div>

<div class="rapport-analyse" id="rapportAnalyse" style="display:none;">
  <h4>Analyse de lâ€™eau (optionnel)</h4>

  <div class="rapport-analyse-grid">
    <div class="form-group">
      <label>pH mesurÃ©</label>
      <input type="number" id="rapPH" step="0.1" placeholder="ex : 7.4">
    </div>

    <div class="form-group">
      <label>Chlore libre (mg/L)</label>
      <input type="number" id="rapChlore" step="0.1" placeholder="ex : 2.5">
    </div>
  </div>
</div>

    <label>Remarques / anomalies</label>
    <textarea id="rapNotes" rows="3"></textarea>

    <div class="popup-buttons">
      <button class="btn btn-success" onclick="saveRapportOnly()">Enregistrer</button>
      <button class="btn btn-secondary" onclick="closeRapportPopup()">Fermer</button>
    </div>
  </div>
</div>



<div id="attestationPopup" class="popup-overlay hidden">
  <div class="popup">
    <h2>Attestation dâ€™entretien clim</h2>

    <label>Nom du client</label>
    <input
  type="text"
  id="attClientName"
  list="clientsList"
  autocomplete="off"
  onchange="onAttClientNameChange()"
  onblur="onAttClientNameChange()"
/>


    <label>Adresse</label>
    <input type="text" id="attClientAddress">

    <label>Date dâ€™intervention</label>
    <input type="date" id="attDate">

    <label>Nombre dâ€™unitÃ©s clim entretenues</label>
    <input type="number" id="attUnits" min="1" value="1">

    <label>Remarques (optionnel)</label>
    <textarea id="attNotes" rows="3"></textarea>

<div class="popup-buttons">
  <button class="btn btn-success" onclick="saveAttestationOnly()">Enregistrer</button>
  <button class="btn btn-secondary" onclick="closeAttestationPopup()">Fermer</button>
</div>

  </div>
</div>


<!-- POPUP ajout manuel planning -->
<div id="planningPopup" class="popup-overlay hidden">
  <div class="popup">
    <h3>Ajouter une intervention</h3>
    <p id="planningPopupDate" class="popup-date"></p>

    <label>Prestation</label>
    <select id="planningPopupPrestation"></select>

    <label>Nom du client</label>
    <input type="text" id="planningPopupClient">

    <label>Adresse</label>
    <input type="text" id="planningPopupAddress">

    <label>TÃ©lÃ©phone</label>
    <input type="text" id="planningPopupPhone">

    <label>Notes</label>
    <textarea id="planningPopupNotes" placeholder="Notes supplÃ©mentaires..."></textarea>

    <div class="popup-buttons">
      <button class="btn btn-primary" onclick="confirmManualPlanningPopup()">Ajouter</button>
      <button class="btn btn-secondary" onclick="closeManualPlanningPopup()">Annuler</button>
    </div>
  </div>
</div>

  <!-- LISTE DES DOCUMENTS -->

  <section id="listView">

<div class="actions no-print">
  <button id="createDevis" class="btn btn-primary" onclick="newDocument('devis')">â• Nouveau devis</button>

 <button id="createContract" class="btn btn-primary" onclick="newContract()">â• Nouveau contrat</button>


  <button id="createFacture" class="btn btn-success" onclick="newDocument('facture')">â• Nouvelle facture</button>

  <button class="btn btn-devis tarifs-button" onclick="openTarifsPanel()">ğŸ“‹ Tarifs prestations</button>
  <button
    class="btn btn-primary"
    type="button"
    onclick="openClientsListPopup()"
  >
    ğŸ‘¥ Clients
  </button>
</div>


    <!-- PANEL TARIFS -->
    <div id="tarifsPanel" class="card no-print hidden">
      <h2>Tarifs des prestations</h2>

      <!-- actions top -->
      <div class="tarifs-actions tarifs-actions-top">
        <button class="btn btn-secondary" onclick="closeTarifsPanel()">â† Retour</button>
        <button class="btn btn-primary" onclick="saveTarifsFromUI()">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-devis" onclick="openAddPrestationPopup()">â• Ajouter</button>
        <button class="btn btn-danger" onclick="resetTarifs()">ğŸ§¹ RÃ©initialiser</button>
      </div>

      <table class="documents-table">
        <thead>
          <tr>
            <th>Prestation</th>
            <th>Prix Particulier</th>
            <th>Prix Syndic</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tarifsTableBody"></tbody>
      </table>

      <div id="descEditor" class="desc-editor hidden">
        <h4>Texte dÃ©taillÃ© du modÃ¨le</h4>
        <label>Texte Particulier</label>
        <textarea id="descPartInput"></textarea>

        <label>Texte Syndic / Agence</label>
        <textarea id="descSynInput"></textarea>

        <div class="desc-editor-buttons">
          <button class="btn btn-primary btn-small" onclick="saveDescEditor()">Enregistrer</button>
          <button class="btn btn-secondary btn-small" onclick="closeDescEditor()">Fermer</button>
        </div>
      </div>

      <div class="tarifs-actions tarifs-actions-bottom">
        <button class="btn btn-secondary" onclick="closeTarifsPanel()">â† Retour</button>
        <button class="btn btn-primary" onclick="saveTarifsFromUI()">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-devis" onclick="openAddPrestationPopup()">â• Ajouter</button>
        <button class="btn btn-danger" onclick="resetTarifs()">ğŸ§¹ RÃ©initialiser</button>
      </div>
    </div>

    <!-- POPUP Ajouter prestation -->
    <div id="prestationPopup" class="popup-overlay hidden">
      <div class="popup">
        <h3 id="popupTitle">Nouvelle prestation</h3>

        <label>Nom de la prestation</label>
        <input type="text" id="popupName">

        <label>Prix Particulier</label>
        <input type="number" id="popupPricePart" step="0.01" oninput="onPopupPricePartChange()">

        <label>Prix Syndic</label>
        <input type="number" id="popupPriceSyn" step="0.01">

        <div class="popup-buttons">
          <button class="btn btn-primary" onclick="confirmPrestationPopup()">Valider</button>
          <button class="btn btn-secondary" onclick="closePrestationPopup()">Annuler</button>
        </div>
      </div>
    </div>

   <!-- TABLEAU DES DOCUMENTS -->
  <div class="card" id="documentsCard">
    <div class="filters-row no-print">
      <span id="listTitle" class="list-title">Liste des devis</span>

      <!-- Groupe filtres Ã  droite -->
      <div class="filters-group">

        <!-- ğŸ” Recherche devis / factures -->
        <div class="doc-search-wrapper">
          <input
            type="text"
            id="docSearchInput"
            placeholder="Rechercher (nÂ°, client, objet...)"
            oninput="onDocumentsSearchChange()"
          />
        </div>

        <!-- Filtre annÃ©e (factures uniquement) -->
        <div id="yearFilterContainer" class="hidden">
          <label>AnnÃ©e</label>
          <select id="yearFilter" onchange="loadDocumentsList()">
            <option value="all">Toutes</option>
          </select>
        </div>

        <!-- Tri (si tu lâ€™as gardÃ©) -->
        <div class="sort-wrapper">
          <label class="filter-label" for="sortDocumentsBy">Trier par</label>
          <select id="sortDocumentsBy" onchange="loadDocumentsList()">
            <option value="date_desc">Date</option>
            <option value="number_desc">NumÃ©ro</option>
          </select>
        </div>

        <!-- Bouton Export CSV -->
        <div id="exportContainer" class="hidden">
          <button
            class="btn btn-secondary btn-small"
            onclick="exportFacturesCSV()"
          >
            ğŸ“¥ Exporter (CSV)
          </button>
        </div>
      </div>
    </div>

    <!-- Filtre "factures impayÃ©es" Ã  l'intÃ©rieur de la carte -->
    <div id="unpaidFilterContainer" class="hidden" style="margin-top:10px;">
      <label style="font-size:14px;">
        <input
          type="checkbox"
          id="filterUnpaid"
          onchange="loadDocumentsList()"
        >
        Afficher seulement les factures impayÃ©es
      </label>
    </div>

    <!-- Alerte contrats Ã  renouveler (en dessous du bloc filtres) -->
    <div id="contractsAlert" class="contracts-alert no-print hidden"></div>
    <div id="contractsFilterBar" class="no-print hidden" style="margin-bottom:10px;">
      <label style="font-size:14px;">
        <input type="checkbox" id="filterRenewal" onchange="loadContractsList()">
        Voir uniquement les contrats Ã  renouveler / terminÃ©s
      </label>
    </div>

    <table class="documents-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>NumÃ©ro</th>
          <th>Client</th>
          <th>Date</th>
          <th>Montant</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="documentsTableBody">
        <tr>
          <td colspan="7" class="no-docs-cell">
            Aucun document pour le moment
          </td>
        </tr>
      </tbody>
    </table>
  </div>


  </section>

  <!-- FORMULAIRE DOCUMENT -->

  <section id="formView" class="hidden">

    <div class="actions no-print">
      <button class="btn btn-secondary" onclick="backToList()">â† Retour</button>
      <button class="btn action-button" onclick="saveDocument()">ğŸ’¾ Enregistrer</button>
      <button class="btn action-button" onclick="openPrintable()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn action-button" onclick="duplicateCurrent()">ğŸ§¾ Dupliquer</button>
      <button id="transformButton" class="btn btn-success" style="display:none;" onclick="transformToInvoice()">ğŸ” Facture</button>
<button id="rapportFromDevisButton" class="btn action-button" onclick="onGenerateRapportFromCurrent()">
  ğŸ“ GÃ©nÃ©rer rapport dâ€™intervention
</button>


  <button id="contractFromDevisButton" class="btn action-button" style="display:none;" onclick="createContractFromDevis()">ğŸ“˜ Contrat</button>
<button class="btn action-button" type="button" onclick="openSendPopup()">ğŸ“¤ Envoyer au client</button>

      <button class="btn btn-danger" onclick="deleteCurrent()">ğŸ—‘ï¸ Supprimer</button>
    </div>

    <div class="card">
      <h2 id="formTitle">Nouveau document</h2>

      <!-- type document -->
      <div class="row">
        <div class="form-group">
         <label class="form-label">
  Type<span class="required-star">*</span>
</label>
          <select id="docType" onchange="updateDocType(); updateTransformButtonVisibility();">
            <option value="devis">Devis</option>
            <option value="facture">Facture</option>
          </select>
        </div>

        <div class="form-group">
          <label>NumÃ©ro</label>
          <input type="text" id="docNumber" readonly>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="date" id="docDate" onchange="onDocDateChange()">
        </div>

        <div class="form-group" id="validityDateGroup">
          <label>Valable jusquâ€™au</label>
          <input type="date" id="validityDate" onchange="onValidityChange()">
          <div id="devisStatusInfo" class="devis-status-info"></div>
        </div>
      </div>

      <div class="form-group">
       <label class="form-label">
  Objet <span class="required-star">*</span>
</label>
        <input type="text" id="docSubject" placeholder="Ex : Entretien piscine + clim â€“ Villa Martin">
      </div>

      <!-- type client -->
      <div class="form-group">
       <label class="form-label">
  Type de client <span class="required-star">*</span>
</label>
        <div class="client-type-row">

          <label class="client-type-option">
            <input type="radio" name="clientType" value="particulier" id="clientParticulier" onchange="selectClientType('particulier')">
            Particulier
          </label>

          <label class="client-type-option">
            <input type="radio" name="clientType" value="syndic" id="clientSyndic" onchange="selectClientType('syndic')">
          Agence immobiliÃ¨re
          </label>

        </div>
      </div>

      <!-- INFORMATIONS CLIENT -->
<h3 class="section-title">Informations client</h3>

<div class="row">
  <div class="form-group" style="max-width: 140px;">
    <label>CivilitÃ©</label>
    <select id="clientCivility">
      <option value="">â€”</option>
      <option value="Monsieur">Monsieur</option>
      <option value="Madame">Madame</option>
      <option value="Monsieur et Madame">Monsieur ou Madame</option>
    </select>
  </div>

  <div class="form-group">
   <label class="form-label">
  Nom ou SociÃ©tÃ© <span class="required-star">*</span>
</label>
    <input
      type="text"
      id="clientName"
      list="clientsList"
      autocomplete="off"
      required
      onchange="onClientNameChange()"
      onblur="onClientNameChange()"
    />
    <datalist id="clientsList"></datalist>
  </div>

  <!-- (le reste de tes champs Adresse / TÃ©lÃ©phone / Email ne bouge pas) -->
</div>


        <div class="form-group">
         <label class="form-label">
  Adresse <span class="required-star">*</span>
</label>
          <input type="text" id="clientAddress">
        </div>

        <div class="form-group">
          <label>TÃ©lÃ©phone</label>
          <input type="tel" id="clientPhone">
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="clientEmail">
        </div>
      </div>

      <!-- boutons clients -->
     <div class="row no-print" style="gap:10px; display:flex;">

  <!-- Ajouter client -->
  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="addCurrentClient()"
  >
    <span class="btn-icon-emoji">â•</span>
    <span>Ajouter ce client</span>
  </button>

  <!-- Voir liste clients -->
  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="openClientsListPopup()"
  >
    <span class="btn-icon-emoji">ğŸ“‹</span>
    <span>Voir liste clients</span>
  </button>

  <!-- Supprimer client -->
  <button
    type="button"
    class="btn btn-danger btn-small btn-icon"
    onclick="deleteCurrentClient()"
  >
    <span class="btn-icon-emoji">ğŸ—‘ï¸</span>
    <span>Supprimer ce client</span>
  </button>

</div>

      <!-- Lieu dâ€™intervention (si syndic/agence) -->
    <div id="siteBlock" class="row" style="display:none;">

  <div class="form-group" style="max-width: 150px;">
    <label>CivilitÃ© lieu</label>
    <select id="siteCivility" style="min-width: 250px;">

      <option value="">â€”</option>
      <option value="Chez Monsieur">Chez Monsieur</option>
      <option value="Chez Madame">Chez Madame</option>
      <option value="Appartement Monsieur">Appartement Monsieur</option>
      <option value="Appartement Madame">Appartement Madame</option>
      <option value="Villa Monsieur">Villa Monsieur</option>
      <option value="Villa Madame">Villa Madame</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label">
  Nom du client sur site <span class="required-star">*</span>
</label>
    <input type="text" id="siteName" placeholder="Ex : Mme Dupont Ã‰lise">
  </div>

  <div class="form-group">
<label class="form-label">
  Adresse du lieu d'intervention <span class="required-star">*</span>
</label>
    <input type="text" id="siteAddress" placeholder="Ex : RÃ©sidence Le Parc, BÃ¢t A, 14 rue ...">
  </div>

</div>


      <!-- PRESTATIONS -->
      <div class="prestations-section">
        <h3 class="section-title">Prestations</h3>

        <div id="prestationsContainer"></div>

        <button id="addPrestationBtn" class="btn action-button no-print" onclick="addPrestation()">
          â• Ajouter une prestation
        </button>
      </div>

      <!-- TOTAUX -->
      <div class="totals">

        <div class="total-line">
          <span>Sous-total HT :</span>
          <span id="subtotalHT">0,00 â‚¬</span>
        </div>

        <!-- RÃ©duction dans la grille -->
        <div class="totals-grid">
          <div class="form-group discount-group">
            <label>RÃ©duction</label>
            <div class="discount-row">
              <label class="discount-toggle">
                <input type="checkbox" id="discountEnabled" onchange="onDiscountToggle()">
                Appliquer une rÃ©duction
              </label>

              <input
                type="number"
                id="discountPercentInput"
                min="0"
                max="100"
                value="0"
                step="0.01"
                oninput="onDiscountPercentChange()"
                disabled
              >
              <span class="discount-percent-symbol">%</span>
            </div>
          </div>
        </div>

        <!-- ğŸ”» BLOC TVA DÃ‰PLACÃ‰ ICI, SOUS LA RÃ‰DUCTION -->
        <div class="form-group tva-group">
          <label>TVA</label>

          <div class="tva-options">
            <label>
              <input type="radio" name="tvaRadio" id="tva0" checked onchange="onMainTvaRadioChange(0)"> 0 %
            </label>
            <label>
              <input type="radio" name="tvaRadio" id="tva20" onchange="onMainTvaRadioChange(20)"> 20 %
            </label>
          </div>

          <div class="tva-rate-wrapper">
            <input type="number" id="tvaRate" value="0" step="0.01" readonly>
            <span class="tva-percent-symbol">%</span>
          </div>
        </div>

        <div id="discountLine" class="total-line" style="display:none;">
          <span id="discountLabel">RÃ©duction :</span>
          <span id="discountAmount">0,00 â‚¬</span>
        </div>

        <div class="total-line">
          <span>TVA :</span>
          <span id="tvaAmount">0,00 â‚¬</span>
        </div>

        <div class="total-line grand-total">
          <span id="totalLabel">NET Ã€ PAYER :</span>
          <span id="totalTTC">0,00 â‚¬</span>
        </div>

        <div class="tva-note" id="tvaNote">TVA non applicable, article 293 B du CGI.</div>
      </div>


      <!-- SECTION PAIEMENT (factures) -->
      <div class="form-group no-print" id="paymentSection">
        <label>RÃ¨glement</label>

        <div class="pay-line">
          <label><input type="radio" name="payMode" id="payNone" value="" checked onchange="onPayModeChange()"> Facture non rÃ©glÃ©e</label>
        </div>

        <div class="pay-line">
          <label><input type="radio" name="payMode" value="especes" id="payEspeces" onchange="onPayModeChange()"> EspÃ¨ces</label>
          <label><input type="radio" name="payMode" value="cb" id="payCB" onchange="onPayModeChange()"> Carte bancaire</label>
          <label><input type="radio" name="payMode" value="virement" id="payVirement" onchange="onPayModeChange()"> Virement</label>
          <label><input type="radio" name="payMode" value="cheque" id="payCheque" onchange="onPayModeChange()"> ChÃ¨que</label>
        </div>

        <div id="paymentDateWrapper" class="payment-date-wrapper">
          <label>Date de rÃ¨glement</label>
          <input type="date" id="paymentDate">
        </div>
      </div>

<div class="form-group no-print devis-signature-trigger">
  <label style="display:flex; align-items:center; gap:10px; margin:0;">
    <input type="radio" id="approveDevis" name="approveDoc" onclick="openSignaturePopup()">
    Bon pour accord â€“ signer Ã©lectroniquement
  </label>
</div>

<!-- ================= HISTORIQUE DOCUMENT ================= -->

<div id="historyCard" class="history-card no-print">
  <h3 class="section-title">Historique du document</h3>
  <div id="historyList" class="history-list">
    <div class="history-empty">Aucune modification pour le moment.</div>
  </div>
</div>

<!-- ================= SANTÃ‰ DU DOCUMENT ================= -->

<div id="documentHealthCard" class="health-card no-print" style="margin-top:20px;">
  <h3 class="section-title">SantÃ© du document</h3>

  <table class="document-health-table">
    <thead>
      <tr>
        <th>CatÃ©gorie</th>
        <th>Statut</th>
        <th>DÃ©tails</th>
      </tr>
    </thead>
    <tbody id="documentHealthBody">
      <tr><td colspan="3">Analyse en cours...</td></tr>
    </tbody>
  </table>
</div>


      <!-- Notes -->
      <div class="form-group">
        <label>Notes / Conditions</label>
        <textarea id="notes" placeholder="Conditions de paiement, garanties, etc."></textarea>
      </div>

      <!-- ACTIONS BAS -->
    <div class="actions no-print">
      <button class="btn btn-secondary" onclick="backToList()">â† Retour</button>
      <button class="btn action-button" onclick="saveDocument()">ğŸ’¾ Enregistrer</button>
      <button class="btn action-button" onclick="openPrintable()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn action-button" onclick="duplicateCurrent()">ğŸ§¾ Dupliquer</button>
      <button id="transformButton" class="btn btn-success" style="display:none;" onclick="transformToInvoice()">ğŸ” Facture</button>
<button id="rapportFromDevisButton" class="btn action-button" onclick="onGenerateRapportFromCurrent()">
  ğŸ“ GÃ©nÃ©rer rapport dâ€™intervention
</button>


  <button id="contractFromDevisButton" class="btn action-button" style="display:none;" onclick="createContractFromDevis()">ğŸ“˜ Contrat</button>
<button class="btn action-button" type="button" onclick="openSendPopup()">ğŸ“¤ Envoyer au client</button>

      <button class="btn btn-danger" onclick="deleteCurrent()">ğŸ—‘ï¸ Supprimer</button>
    </div>

  </section>

<!-- ========================================================= -->
<!-- ===============   PAGE  CONTRAT PISCINE/SPA   ============ -->
<!-- ========================================================= -->

<section id="contractView" class="hidden">

  <div class="actions no-print" style="margin-bottom:20px;">
    <button class="btn btn-secondary" onclick="backToContracts()">â† Retour</button>
    <button class="btn btn-primary" onclick="saveContract()">ğŸ’¾ Enregistrer</button>
    <button class="btn btn-primary" onclick="openContractPDF()">ğŸ–¨ï¸ Imprimer</button>
<button id="contractTransformButtonTop" class="btn btn-success" style="display:none;" onclick="transformContractToInvoice()">ğŸ’¶ Facturer</button>


      <button class="btn btn-primary" onclick="createDevisFromCurrentContract()">ğŸ§¾ CrÃ©er un devis</button>
<button class="btn btn-primary" type="button" onclick="openRenewPopup(currentContractId)">
  <span class="icon">ğŸ”</span> Renouveler
</button>
<button class="btn btn-primary" onclick="openContractSchedulePopup()">
  ğŸ“… Voir lâ€™Ã©chÃ©ancier
</button>
<button class="btn btn-danger" onclick="openResiliationPopup(currentContractId)">ğŸ”´ RÃ©silier</button>
<button class="btn btn-danger" type="button" onclick="markContractNoRenew(currentContractId)">
  ğŸš« Ne pas renouveler
</button>
<button class="btn btn-danger" onclick="deleteCurrentContract()">ğŸ—‘ï¸ Supprimer</button>
  </div>

  <div class="card">
    <div class="contract-header-blue">
  <h2>ğŸŸ¦ Contrat dâ€™entretien Piscine / Spa</h2>
</div>
  <!-- Bandeau lien devis / contrat -->
    <div id="ctDevisBanner"
         class="devis-banner"
         style="display:none; margin:10px 0; padding:8px 12px; background:#e3f2fd; border-left:4px solid #1976d2; border-radius:4px; font-size:14px;">
      <!-- Le texte sera rempli par le JS -->
    </div>


    <!-- ================= INFOS CLIENT ================= -->

<h3 class="section-title">1. Informations client</h3>

<div class="row">
  <div class="form-group">
    <label>CivilitÃ©</label>
    <select id="ctClientCivility">
      <option value="">â€”</option>
      <option value="Monsieur">Monsieur</option>
      <option value="Madame">Madame</option>
      <option value="SociÃ©tÃ©">Monsieur ou Madame</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label">
  Nom ou SociÃ©tÃ© <span class="required-star">*</span>
</label>
   <input
  type="text"
  id="ctClientName"
  list="clientsList"
  autocomplete="off"
  required
  onchange="onContractClientNameChange()"
  onblur="onContractClientNameChange()"
/>

  </div>

  <div class="form-group">
   <label class="form-label">
 Adresse <span class="required-star">*</span>
</label>
    <input type="text" id="ctClientAddress">
  </div>

  <div class="form-group">
    <label>TÃ©lÃ©phone</label>
    <input type="text" id="ctClientPhone">
  </div>

  <div class="form-group">
    <label>Email</label>
    <input type="email" id="ctClientEmail">
  </div>

  <div class="form-group">
    <label>RÃ©fÃ©rence contrat</label>
    <input type="text" id="ctReference">
  </div>
</div>

<!-- Boutons clients pour les contrats -->
<div class="row no-print" style="gap:10px; display:flex; margin-bottom:15px;">

  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="addCurrentClientFromContract()"
  >
    â• Ajouter ce client
  </button>

  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="openClientsListPopup()"
  >
    ğŸ“‹ Voir liste clients
  </button>

  <button
    type="button"
    class="btn btn-danger btn-small btn-icon"
    onclick="deleteCurrentClientFromContract()"
  >
    ğŸ—‘ï¸ Supprimer ce client
  </button>

</div>




   <!-- ================= LIEU ================= -->
<div id="ctSiteSection">
  <h3 class="section-title">2. Lieu dâ€™intervention</h3>

  <div class="row">
    <div class="form-group">
      <label>CivilitÃ© du lieu</label>
      <select id="ctSiteCivility">
        <option value="">â€”</option>
        <option value="Chez Monsieur">Chez Monsieur</option>
        <option value="Chez Madame">Chez Madame</option>
        <option value="Appartement Monsieur">Appartement Monsieur</option>
        <option value="Appartement Madame">Appartement Madame</option>
        <option value="Villa Monsieur">Villa Monsieur</option>
        <option value="Villa Madame">Villa Madame</option>
        <option value="RÃ©sidence">RÃ©sidence</option>
      </select>
    </div>

    <div class="form-group">
     <label class="form-label">
  Nom sur place <span class="required-star">*</span>
</label>
      <input type="text" id="ctSiteName">
    </div>

    <div class="form-group">
      <label class="form-label">
 Adresse du bassin <span class="required-star">*</span>
</label>
      <input type="text" id="ctSiteAddress">
    </div>
  </div>
</div>



    <!-- ================= BASSIN ================= -->
    <h3 class="section-title">3. CaractÃ©ristiques du bassin</h3>

    <div class="row">
<div class="form-group">
  <label>Type de bassin</label>
  <select id="ctPoolType">
    <option value="piscine_chlore">ğŸŠ Piscine au chlore (traitement classique)</option>
    <option value="piscine_sel">ğŸŒŠ Piscine au sel (Ã©lectrolyseur)</option>
    <option value="spa">ğŸ› Spa / Jacuzzi</option>
  </select>
</div>


 <div class="form-group">
  <label>Traitement / Ã©quipement principal</label>
  <select id="ctEquipment">
    <option value="">â€”</option>
    <option value="Traitement manuel">Traitement manuel</option>
    <option value="Ã‰lectrolyseur au sel">Ã‰lectrolyseur au sel</option>
    <option value="RÃ©gulation automatique pH / redox">RÃ©gulation automatique pH / redox</option>
    <option value="Autre (prÃ©cisÃ© en observation)">Autre (prÃ©cisÃ© en observation)</option>
  </select>
</div>


<div class="form-group">
  <label>Volume approximatif (mÂ³)</label>
  <input type="text" id="ctVolume">
</div>

      <div class="form-group">
        <label>ParticularitÃ©s</label>
        <textarea id="ctNotes" placeholder="AccÃ¨s difficile, horaires, animauxâ€¦"></textarea>
      </div>
    </div>


    <!-- ================= FRÃ‰QUENCE ================= -->
    <h3 class="section-title">4. FrÃ©quence & planification</h3>

    <div class="row">
<div class="form-group">
        <label for="ctStartDate">
 Type de client <span class="required-star">*</span>
</label>
  <div class="client-type-row">
    <label class="client-type-option">
      <input type="radio" name="ctClientTypeChoice" value="particulier" id="ctClientParticulier" checked>
      Particulier
    </label>
    <label class="client-type-option">
      <input type="radio" name="ctClientTypeChoice" value="syndic" id="ctClientSyndic">
      Agence immobiliÃ¨re
    </label>
  </div>
  <!-- Valeur utilisÃ©e par le JS (comme avant) -->
  <input type="hidden" id="ctClientType" value="particulier">
</div>


 <div class="form-group">
  <label>Prestation principale (auto pour le tarif)</label>
  <select id="ctMainService" disabled>
    <option value="piscine_chlore">Piscine (Chlore)</option>
    <option value="piscine_sel">Piscine (Sel)</option>
    <option value="entretien_jacuzzi">Spa / Jacuzzi</option>
  </select>
</div>


      <div class="form-group">
        <label>Mode de passages</label>
        <select id="ctMode">
          <option value="standard">Standard : 1/mois hiver â€“ 2/mois Ã©tÃ©</option>
          <option value="intensif">Intensif : 2/mois hiver â€“ 4/mois Ã©tÃ©</option>
          <option value="custom">PersonnalisÃ©</option>
        </select>
      </div>

<div class="form-group">
  <label>Passages hiver (nov â†’ avr)</label>
  <select id="ctPassHiver">
    <option value="0">0 â€“ Sur demande</option>
    <option value="1">1 passage / mois</option>
    <option value="2">2 passages / mois</option>
    <option value="4">4 passages / mois</option>
  </select>
</div>

<div class="form-group">
  <label>Passages Ã©tÃ© (mai â†’ oct)</label>
  <select id="ctPassEte">
    <option value="0">0 â€“ Sur demande</option>
    <option value="1">1 passage / mois</option>
    <option value="2" selected>2 passages / mois</option>
    <option value="4">4 passages / mois</option>
  </select>
</div>

    </div>

    <div class="row">
      <div class="form-group">
        <label for="ctStartDate">
  DÃ©but du contrat <span class="required-star">*</span>
</label>

        <input type="date" id="ctStartDate">
      </div>

 <div class="form-group">
  <label>DurÃ©e du contrat</label>
<select id="ctDuration" class="form-select">
  <option value="4">4 mois â€“ Saison Ã©tÃ© (juin â†’ septembre)</option>
  <option value="5">5 mois â€“ Saison Ã©tendue</option>
  <option value="6">6 mois â€“ Saison longue (mai â†’ octobre)</option>
  <option value="12">12 mois â€“ Annuel</option>
</select>

</div>


      <div class="form-group">
        <label>Fin du contrat (auto)</label>
        <input type="text" id="ctEndDate" readonly>
      </div>

      <div class="form-group">
        <label>PÃ©riode couverte</label>
        <input type="text" id="ctPeriod" readonly>
      </div>

<div class="form-group">
  <label>Total passages (auto)</label>

  <input type="text" id="ctTotalPassages" readonly>

  <div id="ctRecapSummary" class="ct-recap-summary"></div>
  <div id="ctWarning" class="ct-warning hidden"></div>
</div>

    </div>


      <!-- ================= TARIFS ================= -->
    <h3 class="section-title">5. Tarifs & calcul automatique</h3>

    <div class="row">
      <div class="form-group">
        <label>Prix unitaire (auto)</label>
        <input type="text" id="ctUnitPrice" readonly>
      </div>

      <div class="form-group">
        <label>Montant total HT</label>
        <input type="text" id="ctTotalHT" readonly>
      </div>
    </div>
<div class="row">
  <div class="form-group">
  <label for="ctBillingMode">
  Mode de facturation <span class="required-star">*</span>
</label>

<select id="ctBillingMode">
  <option value="mensuel">Mensuel</option>
  <option value="annuel_50_50">Annuel 50/50</option>
  <option value="trimestriel">Trimestriel</option>
  <option value="semestriel">Semestriel</option>
  <option value="annuel">Annuel</option>
</select>

  </div>
</div>

<div class="row">
  <div class="form-group">
    <label>Options dâ€™usage</label>
    <div class="options-box">
      <label class="option-item">
        <input type="checkbox" id="ctAirbnb">
        <span>Usage location saisonniÃ¨re / Airbnb (majoration +20 %)</span>
      </label>
    </div>
  </div>
</div>

<div class="row">
  <div class="form-group">
    <label>Options forfaitaires</label>

    <div class="options-box">
      <label class="option-item">
        <input type="checkbox" id="ctIncludeOpening">
        <span>Mise en service de la piscine avant la saison estivale</span>
      </label>

      <label class="option-item">
        <input type="checkbox" id="ctIncludeWinter">
        <span>Hivernage</span>
      </label>
    </div>

  </div>
</div>

<div class="contract-summary">
  <h4>RÃ©capitulatif</h4>
  <p><strong>Visites :</strong> <span id="ctRecapPassages">0</span></p>
  <p><strong>Prix unitaire :</strong> <span id="ctRecapPrice">0 â‚¬</span></p>
  <p><strong>Total contrat :</strong> <span id="ctRecapTotal">0 â‚¬</span></p>
</div>

<!-- SIGNATURE CONTRAT SYNDIC -->

<div
  id="ctSignatureWrapper"
  class="form-group no-print devis-signature-trigger"
  style="display:none;"
>
  <label>
    <input
      type="radio"
      id="approveContract"
      name="approveContract"
      onclick="openContractSignature()"
    >
    Bon pour accord â€“ signer Ã©lectroniquement
  </label>
</div>

<div class="contract-tva">
  <label>TVA</label>

  <div class="tva-options">
    <label>
      <input
        type="radio"
        name="ctTva"
        id="ctTva0"
        value="0"
        checked
        onchange="onContractTvaRadioChange(0)"
      >
      0 %
    </label>

    <label>
      <input
        type="radio"
        name="ctTva"
        id="ctTva20"
        value="20"
        onchange="onContractTvaRadioChange(20)"
      >
      20 %
    </label>
  </div>
</div>

 <!-- ACTIONS BAS CONTRAT -->
   <div class="actions no-print" style="margin-bottom:20px;">
    <button class="btn btn-secondary" onclick="backToContracts()">â† Retour</button>
    <button class="btn btn-primary" onclick="saveContract()">ğŸ’¾ Enregistrer</button>
    <button class="btn btn-primary" onclick="openContractPDF()">ğŸ–¨ï¸ Imprimer</button>
<button id="contractTransformButtonBottom" class="btn btn-success" style="display:none;" onclick="transformContractToInvoice()">ğŸ’¶ Facturer</button>


     <button class="btn btn-primary" onclick="createDevisFromCurrentContract()">ğŸ§¾ CrÃ©er un devis</button>

<button class="btn btn-primary" type="button" onclick="openRenewPopup(currentContractId)">
  <span class="icon">ğŸ”</span> Renouveler
</button>
<button class="btn btn-primary" onclick="openContractSchedulePopup()">
  ğŸ“… Voir lâ€™Ã©chÃ©ancier
</button>


<button class="btn btn-danger" onclick="openResiliationPopup(currentContractId)">ğŸ”´ RÃ©silier</button>
<button class="btn btn-danger" type="button" onclick="markContractNoRenew(currentContractId)">
  ğŸš« Ne pas renouveler
</button>

    <button class="btn btn-danger" onclick="deleteCurrentContract()">ğŸ—‘ï¸ Supprimer</button>
  </div>

  </div> <!-- fin .card -->

<!-- ================= SANTÃ‰ DU CONTRAT ================= -->

<div id="contractHealthCard" class="health-card no-print" style="margin-top:20px;">
  <h3 class="section-title">SantÃ© du contrat</h3>

  <table class="document-health-table">
    <thead>
      <tr>
        <th>CatÃ©gorie</th>
        <th>Statut</th>
        <th>DÃ©tails</th>
      </tr>
    </thead>
    <tbody id="contractHealthBody">
      <tr><td colspan="3">Analyse en cours...</td></tr>
    </tbody>
  </table>
</div>

</section> <!-- fin #contractView -->



  <!-- ================= POPUP CONFIRM CUSTOM ================= -->
 
 <div id="confirmOverlay" class="confirm-overlay hidden">
    <div class="confirm-box">

      <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
      <h3 class="confirm-title" id="confirmTitle"></h3>
      <p class="confirm-message" id="confirmMessage"></p>

      <div class="confirm-buttons">
        <button id="confirmCancel" class="btn btn-secondary" type="button">Annuler</button>
        <button id="confirmOk" class="btn btn-danger" type="button">OK</button>
      </div>
    </div>
  </div>


<div id="renewPopup" class="popup hidden">
  <h3>Renouvellement du contrat</h3>
  <p>Souhaites-tu renouveler ce contrat pour une nouvelle pÃ©riode ?</p>

  <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
    <button class="btn btn-secondary" onclick="closeRenewPopup()">Annuler</button>
    <button class="btn btn-primary" onclick="confirmRenewPopup()">Renouveler</button>
  </div>
</div>
<div id="contractSchedulePopup" class="popup-overlay hidden">
  <div class="popup">
    <h3>Ã‰chÃ©ancier du contrat</h3>
    <p id="contractScheduleTitle" class="schedule-contract-title"></p>
    <p id="contractSchedulePeriod" class="schedule-contract-period"></p>

    <div id="contractScheduleContent"></div>

    <div class="popup-buttons">
      <button class="btn btn-light" onclick="closeContractSchedulePopup()">Fermer</button>
    </div>
  </div>
</div>


<!-- ================== POPUP CHIFFRE D'AFFAIRES ================== -->
<div id="caReportOverlay" class="ca-overlay hidden">
  <div class="ca-box">
    <div class="ca-header">
      <h3>Chiffre dâ€™affaires</h3>
      <button type="button" class="btn btn-light ca-close" onclick="closeCAReport()">âœ•</button>
    </div>

    <!-- Filtres -->
    <div class="ca-filters-row">
      <div class="ca-filter">
        <label for="caYearSelect">AnnÃ©e :</label>
        <select id="caYearSelect" onchange="renderCAReport()"></select>
      </div>

      <div class="ca-filter">
        <label class="ca-compare-label">
          <input type="checkbox" id="caComparePrevYear" onchange="renderCAReport()">
          Comparer avec N-1
        </label>
      </div>

      <div class="ca-filter ca-export-group">
        <button type="button" class="btn btn-secondary btn-small" onclick="exportCAURSSAFCSV()">
          ğŸ“¤ Export URSSAF
        </button>
        <button type="button" class="btn btn-secondary btn-small" onclick="exportCAFullCSV()">
          ğŸ“Š Export Expert-comptable
        </button>
      </div>
    </div>

    <!-- RÃ©sumÃ© haut niveau -->
    <div class="ca-summary-grid">
      <div class="ca-summary-card">
        <div class="ca-summary-label">CA total TTC</div>
        <div class="ca-summary-value" id="caSummaryTotalTTC">â€“</div>
        <div class="ca-summary-sub" id="caSummaryTotalHT">HT : â€“</div>
      </div>

      <div class="ca-summary-card">
        <div class="ca-summary-label">CA payÃ© TTC</div>
        <div class="ca-summary-value" id="caSummaryPaidTTC">â€“</div>
        <div class="ca-summary-sub" id="caSummaryPaidPct">â€“ % des factures</div>
      </div>

      <div class="ca-summary-card">
        <div class="ca-summary-label">CA impayÃ© TTC</div>
        <div class="ca-summary-value ca-badge-danger" id="caSummaryUnpaidTTC">â€“</div>
        <div class="ca-summary-sub" id="caSummaryUnpaidCount">â€“ factures impayÃ©es</div>
      </div>

      <div class="ca-summary-card">
        <div class="ca-summary-label">TVA collectÃ©e</div>
        <div class="ca-summary-value" id="caSummaryTVA">â€“</div>
        <div class="ca-summary-sub" id="caSummaryTVARate">TVA moyenne : â€“</div>
      </div>

      <div class="ca-summary-card">
        <div class="ca-summary-label">Mois en cours (TTC)</div>
        <div class="ca-summary-value" id="caSummaryCurrentMonth">â€“</div>
        <div class="ca-summary-sub" id="caSummaryCurrentMonthLabel">â€“</div>
      </div>

      <div class="ca-summary-card" id="caSummaryPrevYearCard">
        <div class="ca-summary-label">Ã‰cart vs N-1</div>
        <div class="ca-summary-value" id="caSummaryDelta">â€“</div>
        <div class="ca-summary-sub" id="caSummaryDeltaPct">â€“</div>
      </div>
    </div>

    <!-- Graphique -->
    <div class="ca-chart-wrapper">
      <h4>Ã‰volution mensuelle du CA (TTC)</h4>
      <div id="caChartBars" class="ca-chart-bars"></div>
      <div class="ca-chart-legend">
        <span class="ca-legend-current">â–  AnnÃ©e sÃ©lectionnÃ©e</span>
        <span class="ca-legend-prev" id="caLegendPrevYear">â–  N-1</span>
      </div>
    </div>

    <!-- Tableau mensuel dÃ©taillÃ© -->
    <div class="ca-table-wrapper">
      <h4>Tableau mensuel dÃ©taillÃ©</h4>
      <table class="ca-table">
        <thead>
          <tr>
            <th>Mois</th>
            <th class="text-right">CA HT</th>
            <th class="text-right">TVA</th>
            <th class="text-right">CA TTC</th>
            <th class="text-right">PayÃ©</th>
            <th class="text-right">ImpayÃ©</th>
            <th class="text-right">% rÃ©glÃ©</th>
            <th class="text-right"># factures (payÃ©es / impayÃ©es)</th>
          </tr>
        </thead>
        <tbody id="caTableBody"></tbody>
      </table>
    </div>

    <!-- SynthÃ¨se TVA (utile comptable) -->
    <div class="ca-tva-wrapper">
      <h4>TVA â€“ rÃ©capitulatif annuel</h4>
      <table class="ca-table ca-table-small">
        <thead>
          <tr>
            <th>Base HT</th>
            <th>TVA collectÃ©e</th>
            <th>CA TTC</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-right" id="caTVABaseHT">â€“</td>
            <td class="text-right" id="caTVACollectee">â€“</td>
            <td class="text-right" id="caTVACATTC">â€“</td>
          </tr>
        </tbody>
      </table>
      <p class="ca-tva-note">
        ğŸ” Ã€ transmettre Ã  ton expert-comptable pour la dÃ©claration de TVA et Ã  lâ€™URSSAF
        pour justifier du chiffre dâ€™affaires encaissÃ©.
      </p>
    </div>

    <div class="ca-footer">
      <button type="button" class="btn btn-light" onclick="closeCAReport()">Fermer</button>
    </div>
  </div>
</div>


<!-- POPUP ENVOI DOCUMENT AU CLIENT -->
<div id="sendPopup" class="popup-overlay hidden">
  <div class="popup">
    <h3>Envoyer au client</h3>

    <p id="sendDocInfo" style="margin-bottom:8px; font-weight:600;"></p>

    <label>Message proposÃ©</label>
    <textarea id="sendMessagePreview" rows="7"></textarea>

    <div class="popup-buttons">
      <button class="btn btn-primary btn-small" type="button" onclick="sendByEmail()">âœ‰ï¸ Envoyer par email</button>
      <button class="btn btn-success btn-small" type="button" onclick="sendByWhatsApp()">ğŸ’¬ Envoyer par WhatsApp</button>
      <button class="btn btn-secondary btn-small" type="button" onclick="closeSendPopup()">Fermer</button>
    </div>
  </div>
</div>




  <!-- ================= POPUP RÃ‰SILIATION CONTRAT ================= -->

<div id="resiliationPopup" class="popup hidden">
  <h3>RÃ©siliation du contrat</h3>

<label for="resiliationWho">Qui rÃ©silie ?</label>
  <select id="resiliationWho">
    <option value="client">Le client</option>
    <option value="prestataire">AquaClim Prestige</option>
  </select>

  <label for="resiliationDate" style="margin-top:8px;">Date de rÃ©ception du courrier recommandÃ©</label>
  <input
    type="date"
    id="resiliationDate"
  />
  <p class="resiliation-note">
    Laisse vide pour utiliser la date d'aujourd'hui.
  </p>

  <label for="resiliationMotif" style="margin-top:8px;">Motif de rÃ©siliation</label>
  <textarea
    id="resiliationMotif"
    placeholder="Ex : Vente du bien, dÃ©part, changement de prestataire, impayÃ©s rÃ©pÃ©tÃ©sâ€¦"
    rows="3"
  ></textarea>

  <p class="resiliation-note">
    La rÃ©siliation prendra effet aprÃ¨s rÃ©ception du courrier recommandÃ© et Ã©mission de la facture de clÃ´ture.
  </p>

  <div class="popup-buttons">
    <button type="button" class="btn btn-secondary" onclick="closeResiliationPopup()">Annuler</button>
    <button type="button" class="btn btn-danger" onclick="confirmResiliationPopup()">
      Confirmer la rÃ©siliation
    </button>
  </div>
</div>
  

  <!-- ================= POPUP LISTE CLIENTS ================= -->

  <div id="clientsPopup" class="popup-overlay hidden">
    <div class="popup">

      <h3>Liste des clients</h3>

      <!-- ğŸ” Barre de recherche -->
      <input
        type="text"
        id="clientSearchInput"
        placeholder="Rechercher un client..."
        oninput="filterClientsList()"
        style="width:100%; padding:8px; margin-bottom:12px; border-radius:6px; border:1px solid #ccc;"
      />

      <!-- ğŸ“‹ Liste clients -->
      <div id="clientsListContainer" class="client-list-box"></div>
<!-- Pagination -->
<div id="clientsPagination" class="clients-pagination">
  <button class="btn btn-secondary btn-small" type="button" onclick="prevClientsPage()">â—€</button>
  <span id="clientsPageInfo">Page 1 / 1</span>
  <button class="btn btn-secondary btn-small" type="button" onclick="nextClientsPage()">â–¶</button>
</div>
      <!-- âœï¸ Formulaire dâ€™Ã©dition -->
      <div id="editClientForm" class="hidden" style="margin-top:15px;">
        <h4>Modifier le client</h4>

             <label for="ctStartDate">
 Nom <span class="required-star">*</span>
</label>
        <input type="text" id="editClientName">

             <label for="ctStartDate">
  Adresse <span class="required-star">*</span>
</label>
        <input type="text" id="editClientAddress">

        <label>TÃ©lÃ©phone</label>
        <input type="text" id="editClientPhone">

        <label>Email</label>
        <input type="text" id="editClientEmail">

        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary btn-small" onclick="saveEditedClient()">ğŸ’¾ Enregistrer</button>
          <button class="btn btn-secondary btn-small" onclick="cancelEditClient()">Annuler</button>
        </div>
      </div>

<!-- ğŸ“¤ Export CSV + Fermer -->
<div class="popup-buttons clients-footer">
  <div class="clients-footer-left">
    <button class="btn btn-primary btn-small btn-icon" type="button" onclick="openAddClientFromList()">
  <span class="btn-icon-emoji">â•</span>
  <span>Ajouter un client</span>
</button>

  </div>
  <div class="clients-footer-right">
    <button class="btn btn-primary btn-small" type="button" onclick="exportClientsCSV()">
      ğŸ“¤ Export CSV
    </button>
    <button class="btn btn-secondary btn-small" type="button" onclick="closeClientsListPopup()">
      Fermer
    </button>
  </div>
</div>


  </div> <!-- .popup -->
</div> <!-- #clientsPopup -->

</div> <!-- FIN container -->

<!-- Librairie SignaturePad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

<!-- jsPDF pour gÃ©nÃ©ration des PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- App JS -->
<script src="app.js"></script>

<!-- POPUP SIGNATURE (UNIQUE) -->
<div id="signaturePopup" class="signature-overlay hidden">
  <div class="signature-box">
    <h2 class="signature-title">Signature du client</h2>

    <canvas id="signatureCanvas"></canvas>

<div class="signature-actions">
  <button id="signatureClear" class="btn btn-warning">Effacer</button>
<button id="signatureClose" class="btn btn-secondary">Fermer</button>

  <button id="signatureValidate" class="btn btn-primary">Valider</button>
</div>

  </div>
</div>
</body>
</html>







