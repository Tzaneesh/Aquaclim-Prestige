<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaClim Prestige - Devis & Factures</title>

    <!-- Firebase (scripts CDN compat pour Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a74d9 0%, #0d5ab8 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(26, 116, 217, 0.2);
        }

        .header-inner {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-logo {
            height: 70px;
            width: auto;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .header p {
            opacity: 0.95;
            font-size: 15px;
        }

        .header p.subtitle {
            font-size: 15px;
            font-weight: 600;
        }

        .header p.contact {
            font-size: 14px;
            margin-top: 6px;
            font-weight: 600;
        }

        .top-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary { background: #1a74d9; color: white; }
        .btn-primary:hover {
            background: #0d5ab8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 116, 217, 0.3);
        }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-small { padding: 6px 12px; font-size: 13px; }

        .tab-btn {
            background: #e9ecef;
            color: #333;
        }
        .tab-btn.active {
            background: #1a74d9;
            color: #fff;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #1a74d9;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .form-group { margin-bottom: 16px; }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #1a74d9;
        }

        input[readonly] {
            background: #f5f7fa;
            color: #6c757d;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
        }

        .prestations-section { margin-top: 25px; }

        .prestation-line {
            display: grid;
            grid-template-columns: 2.6fr 1.6fr 0.9fr 0.4fr;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .prestation-line input,
        .prestation-line select,
        .prestation-line textarea {
            margin-bottom: 0;
        }

        .prestation-dates {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .prestation-dates input {
            font-size: 12px;
            padding: 7px;
        }

        .dates-add-btn,
        .note-add-btn {
            margin-top: 4px;
            padding: 4px 10px;
            font-size: 11px;
        }

        .qty-price-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .qty-price-group label { font-size: 12px; }

        .totals {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-line.grand-total {
            font-size: 18px;
            font-weight: bold;
            color: #000;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 10px;
        }

        .tva-note {
            margin-top: 8px;
            font-size: 12px;
            font-style: italic;
            color: #555;
        }

        .documents-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
            table-layout: fixed;
        }

        .documents-table th {
            background: #1a74d9;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        .documents-table td {
            padding: 10px;
            border-bottom: 1px solid #e1e8ed;
            vertical-align: middle;
        }

        .documents-table tr:hover { background: #f8f9fa; }

        .documents-table th:nth-child(6),
        .documents-table td.status-cell {
            width: 260px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-devis   { background: #e3f2fd; color: #1976d2; }
        .badge-facture { background: #e8f5e9; color: #388e3c; }
        .badge-paid    { background: #e8f5e9; color: #1b5e20; }
        .badge-unpaid  { background: #ffebee; color: #c62828; }

        .badge-devis-en-attente { background: #fff3cd; color: #856404; }
        .badge-devis-accepte    { background: #e8f5e9; color: #2e7d32; }
        .badge-devis-refuse     { background: #ffebee; color: #c62828; }
        .badge-devis-expire     { background: #ffe0b2; color: #ef6c00; }

        .hidden { display: none !important; }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e1e8ed;
            flex-wrap: wrap;
        }

        .filters-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .filters-row select { max-width: 160px; }

        @media (max-width: 768px) {
            .prestation-line {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .header h1 { font-size: 26px; }
            .btn { width: 100%; }
        }

        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-inner">
            <img src="logo.png" alt="AquaClim Prestige" class="header-logo">
            <div>
                <h1>AquaClim Prestige</h1>
                <p class="subtitle">Entretien & D√©pannage - Climatisation & Piscine</p>
                <p class="contact">
                    Le Blevennec Lo√Øc ‚Äì 2 avenue Cauvin, 06100 Nice<br>
                    T√©l : 06 03 53 77 73 ‚Äì Email : aquaclimprestige@gmail.com<br>
                    SIRET : <strong>XXXXXXXXXXXXX</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Onglets devis / factures -->
    <div class="top-nav no-print">
        <button id="tabDevis" class="btn tab-btn active" type="button" onclick="switchListType('devis')">üìÑ Devis</button>
        <button id="tabFactures" class="btn tab-btn" type="button" onclick="switchListType('facture')">üí∞ Factures</button>
    </div>

    <!-- Vue Liste -->
    <div id="listView">
        <div class="actions no-print">
            <button class="btn btn-primary" type="button" onclick="newDocument('devis')">‚ûï Nouveau devis</button>
            <button class="btn btn-success" type="button" onclick="newDocument('facture')">üìÑ Nouvelle facture</button>
        </div>

        <div class="card">
            <div class="filters-row no-print">
                <span id="listTitle" style="font-weight:600;color:#1a74d9;">Liste des devis</span>
                <div id="yearFilterContainer" class="hidden">
                    <label for="yearFilter" style="margin-bottom:0;font-weight:500;font-size:12px;">Ann√©e factures</label>
                    <select id="yearFilter" onchange="loadDocumentsList()">
                        <option value="all">Toutes</option>
                    </select>
                </div>
                <div id="exportContainer" class="hidden">
                    <button class="btn btn-secondary btn-small" type="button" onclick="exportFacturesCSV()">üì• Exporter factures (CSV)</button>
                </div>
            </div>

            <table class="documents-table">
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Num√©ro</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="documentsTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; color: #999;">Aucun document pour le moment</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Vue Formulaire -->
    <div id="formView" class="hidden">
        <div class="actions no-print">
            <button class="btn btn-secondary" type="button" onclick="backToList()">‚Üê Retour</button>
            <button class="btn btn-success" type="button" onclick="saveDocument()">üíæ Enregistrer</button>
            <button class="btn btn-primary" type="button" onclick="openPrintable()">üñ®Ô∏è Imprimer / PDF</button>
            <button id="transformButton" class="btn btn-success" type="button" onclick="transformToInvoice()" style="display:none;">üîÅ Transformer en facture</button>
            <button class="btn btn-danger" type="button" onclick="deleteCurrent()">üóëÔ∏è Supprimer</button>
        </div>

        <div class="card">
            <h2 id="formTitle">Nouveau document</h2>

        <div class="row">
    <div class="form-group">
        <label>Type de document *</label>
        <select id="docType" onchange="updateDocType(); updateTransformButtonVisibility();">
            <option value="devis">Devis</option>
            <option value="facture">Facture</option>
        </select>
    </div>

   <div class="form-group">
    <label>Num√©ro</label>
    <input type="text" id="docNumber" readonly>
</div>
<div class="form-group">
    <label>Date du document</label>
    <input type="date" id="docDate" onchange="onDocDateChange()">
</div>
<div class="form-group" id="validityDateGroup">
    <label>Valable jusqu'au</label>
    <input type="date" id="validityDate" onchange="onValidityChange()">
    <div id="devisStatusInfo" style="font-size:12px;color:#c62828;margin-top:4px;display:none;"></div>
</div>
</div> <!-- fin de la premi√®re .row -->
<div class="form-group" style="margin-top:10px;">
    <label>Objet du devis / de la facture</label>
    <input type="text" id="docSubject" placeholder="Ex : Entretien piscine + clim ‚Äì Villa Martin">
</div>

<!-- NOUVELLE ROW : choix Particulier / Syndic en haut --><div class="form-group" style="margin-top:10px;">
    <label>Type de client *</label>

    <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
        <label style="font-size:12px; margin:0; display:flex; align-items:center;">
            <input type="checkbox" id="clientParticulier" onchange="selectClientType('particulier')" style="margin-right:5px;">
            Particulier
        </label>

        <label style="font-size:12px; margin:0; display:flex; align-items:center;">
            <input type="checkbox" id="clientSyndic" onchange="selectClientType('syndic')" style="margin-right:5px;">
            Syndic / Agence
        </label>
    </div>
</div>





          <h3 style="color:#1a74d9;margin:25px 0 15px;">Informations client</h3>
            <div class="row">
                <div class="form-group">
                    <label>Nom ou Soci√©t√© *</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Adresse *</label>
                    <input type="text" id="clientAddress" required>
                </div>
                <div class="form-group">
                    <label>T√©l√©phone</label>
                    <input type="tel" id="clientPhone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail">
                </div>
            </div>

            <div class="prestations-section">
                <h3 style="color:#1a74d9;margin-bottom:12px;">Prestations</h3>
                <div id="prestationsContainer"></div>
           <button class="btn btn-primary no-print" type="button" onclick="addPrestation()">‚ûï Ajouter une prestation</button>



            </div>

            <div class="totals">
                <div class="total-line">
                    <span>Sous-total HT :</span>
                    <span id="subtotalHT">0,00 ‚Ç¨</span>
                </div>

                <!-- R√©duction en pourcentage -->
                <div class="form-group" style="margin:8px 0;">
                    <label>R√©duction</label>
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                        <label style="font-size:12px;">
                            <input type="checkbox" id="discountEnabled" onchange="onDiscountToggle()">
                            Appliquer une r√©duction
                        </label>
                        <input type="number" id="discountPercentInput" value="0" min="0" max="100" step="0.01" style="max-width:120px;" oninput="onDiscountPercentChange()" disabled>
                        <span style="font-size:12px;color:#555;">%</span>
                    </div>
                </div>

                <div class="total-line" id="discountLine" style="display:none;">
                    <span id="discountLabel">R√©duction :</span>
                    <span id="discountAmount">0,00 ‚Ç¨</span>
                </div>

                <div class="form-group" style="max-width: 260px;">
                    <label>TVA</label>
                    <div>
                        <label style="margin-right:10px;font-size:12px;">
                            <input type="radio" name="tvaRadio" id="tva0" onchange="setTVA(0)" checked> 0 %
                        </label>
                        <label style="font-size:12px;">
                            <input type="radio" name="tvaRadio" id="tva20" onchange="setTVA(20)"> 20 %
                        </label>
                    </div>
                    <input type="number" id="tvaRate" value="0" step="0.01" readonly>
                </div>
                <div class="total-line">
                    <span>TVA :</span>
                    <span id="tvaAmount">0,00 ‚Ç¨</span>
                </div>
                <div class="total-line grand-total">
                    <span id="totalLabel">NET √Ä PAYER :</span>
                    <span id="totalTTC">0,00 ‚Ç¨</span>
                </div>
                <div class="tva-note" id="tvaNote">
                    TVA non applicable, article 293 B du CGI.
                </div>
            </div>

            <div class="form-group no-print" style="margin-top:5px;" id="paymentSection">
                <label>R√®glement</label>
                <div style="font-size:12px;margin-bottom:4px;">
                    <label><input type="radio" name="payMode" value="" id="payNone" onchange="onPayModeChange()" checked> Facture non r√©gl√©e</label>
                </div>
                <div style="font-size:12px;margin-bottom:4px;">
                    <label style="margin-right:10px;"><input type="radio" name="payMode" value="especes" id="payEspeces" onchange="onPayModeChange()"> Esp√®ces</label>
                    <label style="margin-right:10px;"><input type="radio" name="payMode" value="cb" id="payCB" onchange="onPayModeChange()"> Carte bancaire</label>
                    <label style="margin-right:10px;"><input type="radio" name="payMode" value="virement" id="payVirement" onchange="onPayModeChange()"> Virement</label>
                    <label><input type="radio" name="payMode" value="cheque" id="payCheque" onchange="onPayModeChange()"> Ch√®que</label>
                </div>
                <div id="paymentDateWrapper" style="margin-top:4px;display:none;">
                    <label style="font-size:12px;margin-bottom:2px;">Date de r√®glement</label>
                    <input type="date" id="paymentDate">
                </div>
            </div>

            <div class="form-group" style="margin-top:10px;">
                <label>Notes / Conditions</label>
                <textarea id="notes" placeholder="Conditions de paiement, garanties, notes diverses..."></textarea>
            </div>

            <div class="form-actions no-print">
                <button class="btn btn-success" type="button" onclick="saveDocument()">üíæ Enregistrer</button>
                <button class="btn btn-primary" type="button" onclick="openPrintable()">üñ®Ô∏è Imprimer / PDF</button>
                <button class="btn btn-secondary" type="button" onclick="backToList()">‚Üê Retour</button>
            </div>
        </div>
    </div>
</div>

<script>
// ------- Mod√®les de prestations V5 (P/S, descriptions simplifi√©es & jacuzzi ajout√©s) -------
const PRESTATION_TEMPLATES = [
    {
        label: "‚Äî Choisir un mod√®le ‚Äî",
        kind: "",
        title: "",
        priceParticulier: null,
        priceSyndic: null,
        descParticulier: "",
        descSyndic: ""
    },

    // 1. Entretien climatisation
    {
        label: "Entretien climatisation",
        kind: "entretien_clim",
        title: "Entretien climatisation",
        priceParticulier: 90,
        priceSyndic: 110,
        descParticulier: "Nettoyage filtres, turbine, √©vaporateur et bac √† condensats. Contr√¥le √©vacuation et nettoyage groupe ext√©rieur.",
        descSyndic: "Nettoyage complet int√©rieur/ext√©rieur, contr√¥le √©vacuation, d√©sinfection et v√©rification installation. Contr√¥le temp√©ratures et rapport gestionnaire."
    },

    // 2. Entretien piscine chlore
    {
        label: "Entretien piscine chlore",
        kind: "piscine_chlore",
        title: "Entretien piscine chlore",
        priceParticulier: 80,
        priceSyndic: 100,
        descParticulier: "Analyse de l‚Äôeau, nettoyage bassin, contr√¥le filtration, rin√ßage et ajustement traitement.",
        descSyndic: "Analyse compl√®te, nettoyage bassin, contr√¥le local technique, pression filtre, rin√ßage, v√©rification pompe et rapport gestionnaire."
    },

    // 3. Entretien piscine sel
    {
        label: "Entretien piscine sel",
        kind: "piscine_sel",
        title: "Entretien piscine sel",
        priceParticulier: 80,
        priceSyndic: 100,
        descParticulier: "Analyse eau, nettoyage bassin, contr√¥le cellule √©lectrolyse, pompe et filtration. R√©glage production de sel.",
        descSyndic: "Analyse compl√®te, nettoyage, contr√¥le cellule et production, v√©rification filtration, r√©glages bo√Ætier et rapport gestionnaire."
    },

    // 4. Entretien jacuzzi
    {
        label: "Entretien jacuzzi",
        kind: "entretien_jacuzzi",
        title: "Entretien jacuzzi / spa",
        priceParticulier: 70,
        priceSyndic: 90,
        descParticulier: "Nettoyage spa, filtres, contr√¥le eau, d√©sinfection buses et v√©rification pompe/chauffage.",
        descSyndic: "Nettoyage complet, analyse eau, d√©sinfection, contr√¥le installation, pompes/chauffage et rapport gestionnaire."
    },

    // 5. Hivernage piscine
    {
        label: "Hivernage piscine",
        kind: "hivernage_piscine",
        title: "Hivernage piscine",
        priceParticulier: 100,
        priceSyndic: 120,
        descParticulier: "Nettoyage, baisse niveau eau, ajout produit d‚Äôhivernage et s√©curisation local technique.",
        descSyndic: "Nettoyage complet, abaissement contr√¥l√©, purge √©ventuelle, s√©curisation local technique et rapport gestionnaire."
    },

    // 6. Remise en service piscine
    {
        label: "Remise en service piscine",
        kind: "remise_service_piscine",
        title: "Remise en service piscine",
        priceParticulier: 100,
        priceSyndic: 120,
        descParticulier: "Nettoyage, remise en route filtration, analyse eau et r√©glages n√©cessaires.",
        descSyndic: "Red√©marrage complet, analyse et r√©glages, contr√¥le local technique, √©tanch√©it√© et rapport gestionnaire."
    },

    // 7. Vidange + nettoyage jacuzzi
    {
        label: "Vidange + nettoyage jacuzzi",
        kind: "vidange_jacuzzi",
        title: "Vidange et nettoyage jacuzzi / spa",
        priceParticulier: 120,
        priceSyndic: 150,
        descParticulier: "Vidange compl√®te, nettoyage cuve/buses, nettoyage filtre, remise en eau et √©quilibrage.",
        descSyndic: "Vidange compl√®te, nettoyage cuve/buses, remise en eau, √©quilibrage et rapport gestionnaire."
    },

    // 8. Traitement choc piscine
    {
        label: "Traitement choc piscine",
        kind: "traitement_choc",
        title: "Traitement choc piscine",
        priceParticulier: 70,
        priceSyndic: 90,
        descParticulier: "Application traitement choc, remise en route filtration et rin√ßage apr√®s clarification.",
        descSyndic: "Traitement adapt√©, suivi filtration, analyse apr√®s traitement, rin√ßage filtre et rapport gestionnaire."
    },

    // 9. Changement sable / charge filtre
    {
        label: "Changement sable / charge filtre",
        kind: "changement_sable",
        title: "Changement sable / charge filtre",
        priceParticulier: 300,
        priceSyndic: 360,
        descParticulier: "Vidange filtre, remplacement charge, rin√ßage et remise en service.",
        descSyndic: "Vidange compl√®te, nettoyage cuve, contr√¥le cr√©pines, remplacement charge, rin√ßage et rapport gestionnaire."
    },

    // 10. Remplacement roulement pompe piscine
    {
        label: "Remplacement roulement pompe piscine",
        kind: "remplacement_roulement",
        title: "Remplacement roulement pompe piscine",
        priceParticulier: 180,
        priceSyndic: 220,
        descParticulier: "Remplacement roulements pompe.",
        descSyndic: "D√©montage, extraction, remplacement roulement, remontage, test et rapport technicien."
    },

    // 11. Remplacement pompe piscine (MO)
    {
        label: "Remplacement pompe piscine (MO)",
        kind: "remplacement_pompe_mo",
        title: "Remplacement pompe piscine (main-d‚Äô≈ìuvre uniquement)",
        priceParticulier: 150,
        priceSyndic: 180,
        descParticulier: "Remplacement pompe (main d‚Äô≈ìuvre uniquement).",
        descSyndic: "D√©pose/installation, raccordement, r√©glages et rapport technicien. Main d‚Äô≈ìuvre uniquement."
    },

    // 12. Remplacement cellule √©lectrolyseur (MO)
    {
        label: "Remplacement cellule √©lectrolyseur (MO)",
        kind: "remplacement_cellule_mo",
        title: "Remplacement cellule √©lectrolyseur (main-d‚Äô≈ìuvre uniquement)",
        priceParticulier: 120,
        priceSyndic: 150,
        descParticulier: "Remplacement cellule, contr√¥le √©tanch√©it√©.",
        descSyndic: "D√©pose/installation, test production, r√©glages, contr√¥le √©tanch√©it√© et rapport."
    },

    // 13. Nettoyage local technique
    {
        label: "Nettoyage local technique",
        kind: "nettoyage_local",
        title: "Nettoyage local technique",
        priceParticulier: 30,
        priceSyndic: 50,
        descParticulier: "Nettoyage local technique, d√©poussi√©rage et contr√¥le humidit√©.",
        descSyndic: "Nettoyage complet, d√©gagement acc√®s appareils, contr√¥le mat√©riel, ventilation et rapport gestionnaire."
    },

    // 14. D√©placement
    {
        label: "D√©placement",
        kind: "deplacement",
        title: "D√©placement",
        priceParticulier: 50,
        priceSyndic: 50,
        descParticulier: "Forfait d√©placement.",
        descSyndic: "Forfait d√©placement."
    },

    // 15. D√©pannage climatisation
    {
        label: "D√©pannage climatisation (horaire)",
        kind: "depannage_clim",
        title: "Diagnostic et d√©pannage climatisation",
        priceParticulier: 120,
        priceSyndic: 150,
        descParticulier: "Diagnostic, tests √©lectriques, v√©rification soufflage et remise en service si possible. Hors pi√®ces.",
        descSyndic: "Diagnostic complet, contr√¥le composants, s√©curit√©s, soufflage et rapport gestionnaire. Hors pi√®ces."
    },

    // 16. D√©pannage piscine
    {
        label: "D√©pannage piscine (horaire)",
        kind: "depannage_piscine",
        title: "Diagnostic et d√©pannage piscine",
        priceParticulier: 120,
        priceSyndic: 150,
        descParticulier: "Diagnostic installation, filtration, pompe, vanne et accessoires. Hors pi√®ces.",
        descSyndic: "Diagnostic complet : pompe, filtration, √©lectrolyse, tests fuite/pression et rapport gestionnaire. Hors pi√®ces."
    },

    // 17. D√©pannage jacuzzi
    {
        label: "D√©pannage jacuzzi",
        kind: "depannage_jacuzzi",
        title: "Diagnostic et d√©pannage jacuzzi / spa",
        priceParticulier: 120,
        priceSyndic: 150,
        descParticulier: "Diagnostic panne : pompe, chauffage, fuite, carte. Tests √©lectriques et hydrauliques. Hors pi√®ces.",
        descSyndic: "Diagnostic complet, tests √©lectriques/hydrauliques, recherche fuite/d√©faut et rapport gestionnaire. Hors pi√®ces."
    },

    // 18. Produits
    {
        label: "Produits",
        kind: "produits",
        title: "",
        priceParticulier: 0,
        priceSyndic: 0,
        descParticulier: "",
        descSyndic: ""
    },

    // 19. Fournitures
    {
        label: "Fournitures",
        kind: "fournitures",
        title: "",
        priceParticulier: 0,
        priceSyndic: 0,
        descParticulier: "",
        descSyndic: ""
    }
];




   let currentDocumentId = null;
let prestationCount = 0;
let currentListType = "devis";

// ------- Firebase (cloud sync) -------
let db = null;

async function initFirebase() {
    if (!window.firebase) {
        console.error("Firebase non disponible");
        return;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDLrNwmfmbpmGkJYdswlOP3qSgFMbCjy0k",
      authDomain: "aquaclim-prestige-e70d6.firebaseapp.com",
      projectId: "aquaclim-prestige-e70d6",
      storageBucket: "aquaclim-prestige-e70d6.firebasestorage.app",
      messagingSenderId: "305566055348",
      appId: "1:305566055348:web:175c174c115ca457bd50e1"
    };

    // Initialisation Firebase
    if (firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();

    console.log("Firebase initialis√©, db =", db ? "OK" : "NULL");


    try {
        // On r√©cup√®re les documents depuis Firestore
        const snapshot = await db.collection("documents").get();
        const cloudDocs = [];
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data) cloudDocs.push(data);
        });

        if (cloudDocs.length > 0) {
            // üíæ On √©crase le localStorage avec ce qu'il y a dans le cloud
            localStorage.setItem("documents", JSON.stringify(cloudDocs));
        } else {
            // üü° Si Firestore est vide mais qu'on a d√©j√† des donn√©es locales, on les pousse dans le cloud
            const local = localStorage.getItem("documents");
            if (local) {
                const docs = JSON.parse(local);
                for (const d of docs) {
                    if (d.id) {
                        await db.collection("documents").doc(d.id).set(d);
                    }
                }
            }
        }

        // On recharge la liste maintenant que tout est synchronis√©
        if (typeof loadYearFilter === "function") loadYearFilter();
        if (typeof loadDocumentsList === "function") loadDocumentsList();
    } catch (e) {
        console.error("Erreur de synchronisation Firestore :", e);
    }
}

// ------- Helpers -------
function formatEuro(value) {

        return value.toLocaleString("fr-FR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + " ‚Ç¨";
    }

    function isDevisExpired(docType, validityDate) {
        if (docType !== "devis" || !validityDate) return false;
        const today = new Date();
        today.setHours(0,0,0,0);
        const v = new Date(validityDate);
        v.setHours(0,0,0,0);
        return v.getTime() < today.getTime();
    }

    function refreshDevisStatusUI(docType, validityDate) {
        const info = document.getElementById("devisStatusInfo");
        if (!info) return;
        if (docType !== "devis" || !validityDate) {
            info.style.display = "none";
            info.textContent = "";
            return;
        }
        if (isDevisExpired(docType, validityDate)) {
            info.style.display = "block";
            info.textContent = "‚ö† Ce devis est expir√© en fonction de la date de validit√©.";
        } else {
            info.style.display = "none";
            info.textContent = "";
        }
    }

    // ------- LocalStorage helpers -------
    function getAllDocuments() {
        const data = localStorage.getItem("documents");
        return data ? JSON.parse(data) : [];
    }
function getDocument(id) {
    return getAllDocuments().find(d => d.id === id) || null;
}

function saveDocuments(docs) {
    console.log("saveDocuments appel√©, nb docs =", docs.length);

    // Sauvegarde locale (comme avant)
    localStorage.setItem("documents", JSON.stringify(docs));

    // Sauvegarde dans Firestore si dispo
    if (db) {
        console.log("db est OK, envoi vers Firestore...");
        docs.forEach(doc => {
            if (!doc.id) return;
            console.log(" ‚Üí Envoi doc id =", doc.id);
            db.collection("documents")
              .doc(doc.id)
              .set(doc)
              .then(() => console.log("   ‚úî Doc enregistr√© dans Firestore :", doc.id))
              .catch(err => console.error("Erreur Firestore save :", err));
        });
    } else {
        console.warn("db est NULL dans saveDocuments, pas d‚Äôenvoi Firestore");
    }
}



    // ------- Num√©rotation par ann√©e (DEV-AAAA-001 / FAC-AAAA-001) -------
    function getNextNumber(type) {
        const year = new Date().getFullYear();
        const prefix = type === "devis" ? "DEV" : "FAC";
        const docs = getAllDocuments().filter(d => d.type === type && typeof d.number === "string");

        const used = [];
        docs.forEach(d => {
            const m = d.number.match(/^([A-Z]{3})-(\d{4})-(\d{3})$/);
            if (!m) return;
            if (m[1] !== prefix) return;
            const docYear = parseInt(m[2], 10);
            const num = parseInt(m[3], 10);
            if (docYear === year && !isNaN(num)) used.push(num);
        });

        used.sort((a, b) => a - b);
        let next = 1;
        for (let i = 0; i < used.length; i++) {
            if (used[i] === next) next++;
            else if (used[i] > next) break;
        }
        return prefix + "-" + year + "-" + String(next).padStart(3, "0");
    }

    // ------- Tabs Devis / Factures -------
    function switchListType(type) {
        currentListType = type;
        document.getElementById("tabDevis").classList.toggle("active", type === "devis");
        document.getElementById("tabFactures").classList.toggle("active", type === "facture");
        document.getElementById("listTitle").textContent = type === "devis" ? "Liste des devis" : "Liste des factures";
        document.getElementById("yearFilterContainer").classList.toggle("hidden", type !== "facture");
        document.getElementById("exportContainer").classList.toggle("hidden", type !== "facture");

        document.getElementById("formView").classList.add("hidden");
        document.getElementById("listView").classList.remove("hidden");
        currentDocumentId = null;

        loadYearFilter();
        loadDocumentsList();
    }

    function loadYearFilter() {
        const select = document.getElementById("yearFilter");
        if (!select) return;
        select.innerHTML = '<option value="all">Toutes</option>';
        if (currentListType !== "facture") return;
        const docs = getAllDocuments().filter(d => d.type === "facture");
        const years = new Set();
        docs.forEach(d => {
            if (d.date) years.add(new Date(d.date).getFullYear());
        });
        Array.from(years).sort().forEach(y => {
            const opt = document.createElement("option");
            opt.value = String(y);
            opt.textContent = y;
            select.appendChild(opt);
        });
    }

    // ------- TVA, Doc type -------
    function updateTransformButtonVisibility() {
        const btn = document.getElementById("transformButton");
        if (!btn) return;
        const type = document.getElementById("docType").value;
        btn.style.display = (type === "devis" && currentDocumentId) ? "inline-block" : "none";
    }

    function updateDocType() {
        const type = document.getElementById("docType").value;
        const validityGroup = document.getElementById("validityDateGroup");
        const paymentSection = document.getElementById("paymentSection");
        const docDate = document.getElementById("docDate").value;
        const validityInput = document.getElementById("validityDate");

        if (type === "devis") {
            validityGroup.style.display = "block";
            const base = docDate ? new Date(docDate) : new Date();
            const validity = new Date(base);
            validity.setDate(validity.getDate() + 30);
            validityInput.value = validity.toISOString().split("T")[0];
            paymentSection.classList.add("hidden");
        } else {
            validityGroup.style.display = "none";
            validityInput.value = "";
            paymentSection.classList.remove("hidden");
        }

        refreshDevisStatusUI(type, validityInput.value);
    }

    function onDocDateChange() {
        if (document.getElementById("docType").value === "devis") {
            updateDocType();
        }
    }

    function onValidityChange() {
        const type = document.getElementById("docType").value;
        const validityDate = document.getElementById("validityDate").value;
        refreshDevisStatusUI(type, validityDate);
    }

function setTVA(rate) {
    const tvaInput   = document.getElementById("tvaRate");
    const tvaNote    = document.getElementById("tvaNote");
    const totalLabel = document.getElementById("totalLabel");

    if (tvaInput) {
        tvaInput.value = rate.toString();
    }

    const clientType = getCurrentClientType(); // "particulier" ou "syndic"

    if (rate === 0) {
        if (clientType === "syndic") {
            // SYNDIC + TVA 0 % -> TOTAL HT
            if (tvaNote)   tvaNote.textContent   = "";
            if (totalLabel) totalLabel.textContent = "TOTAL HT :";
        } else {
            // PARTICULIER + TVA 0 % -> TOTAL √Ä PAYER + mention 293B
            if (tvaNote)   tvaNote.textContent   = "TVA non applicable, article 293 B du CGI.";
            if (totalLabel) totalLabel.textContent = "NET √Ä PAYER :";
        }
    } else {
        // TVA 20 % -> toujours TOTAL TTC
        if (tvaNote)   tvaNote.textContent   = "";
        if (totalLabel) totalLabel.textContent = "TOTAL TTC :";
    }

    calculateTotals();
}


    // ------- Paiement form -------
    function resetPaymentForm() {
        const none = document.getElementById("payNone");
        if (none) none.checked = true;
        const modes = ["payEspeces","payCB","payVirement","payCheque"];
        modes.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.checked = false;
        });
        const dateEl = document.getElementById("paymentDate");
        if (dateEl) dateEl.value = "";
        const wrapper = document.getElementById("paymentDateWrapper");
        if (wrapper) wrapper.style.display = "none";
    }

    function onPayModeChange() {
        const sel = document.querySelector('input[name="payMode"]:checked');
        const wrapper = document.getElementById("paymentDateWrapper");
        const dateInput = document.getElementById("paymentDate");
        if (!wrapper || !dateInput) return;

        if (!sel || !sel.value) {
            wrapper.style.display = "none";
            dateInput.value = "";
            return;
        }

        wrapper.style.display = "block";

        if (!dateInput.value) {
            const docDate = document.getElementById("docDate")?.value;
            dateInput.value = docDate || new Date().toISOString().split("T")[0];
        }
    }

    // ------- R√©duction en % -------
    function onDiscountToggle() {
        const cb = document.getElementById("discountEnabled");
        const input = document.getElementById("discountPercentInput");
        const line = document.getElementById("discountLine");
        if (!cb || !input || !line) return;

        if (cb.checked) {
            input.disabled = false;
        } else {
            input.disabled = true;
            input.value = 0;
            line.style.display = "none";
        }
        calculateTotals();
    }

    function onDiscountPercentChange() {
        calculateTotals();
    }

    // ------- Prestations -------
    function addPassageDate(btn) {
        const container = btn.closest(".form-group").querySelector(".prestation-dates");
        if (!container) return;
        const input = document.createElement("input");
        input.type = "text";
        input.className = "prestation-date";
        input.placeholder = "JJ/MM/AAAA";
        container.appendChild(input);
    }

    function toggleNote(btn) {
        const note = btn.closest(".form-group").querySelector(".prestation-note");
        if (!note) return;
        note.classList.toggle("hidden");
    }

function addPrestation() {
    prestationCount++;
    const container = document.getElementById("prestationsContainer");
    const line = document.createElement("div");
    line.className = "prestation-line";
    line.id = "prestation-" + prestationCount;
    line.dataset.kind = "";
    line.dataset.detail = "";
    line.dataset.basePrice = "0";
    line.dataset.autoPrice = "1"; // prix auto actif par d√©faut

    const optionsHtml = PRESTATION_TEMPLATES.map((t, idx) =>
        '<option value="' + idx + '">' + t.label + '</option>'
    ).join("");

    line.innerHTML =
        '<div class="form-group">' +
            '<label>Mod√®le</label>' +
            '<select class="prestation-template" onchange="applyTemplate(this)">' + optionsHtml + '</select>' +
            '<label style="margin-top:6px;">Intitul√©</label>' +
            '<input type="text" class="prestation-desc" placeholder="Ex: Forfait entretien piscine, D√©pannage clim..." onchange="calculateTotals()">' +
            '<label style="margin-top:6px;">Dates de passage</label>' +
            '<div class="prestation-dates">' +
                '<input type="text" class="prestation-date" placeholder="JJ/MM/AAAA">' +
            '</div>' +
            '<button type="button" class="btn btn-secondary btn-small dates-add-btn no-print" onclick="addPassageDate(this)">‚ûï Ajouter une date</button>' +
        '</div>' +
        '<div class="form-group">' +
            '<div class="qty-price-group">' +
                '<div>' +
                    '<label>Quantit√©</label>' +
                    '<input type="number" class="prestation-qty" value="1" min="0" step="1" onchange="calculateTotals()">' +
                '</div>' +
                '<div>' +
                    '<label>Unit√©</label>' +
                    '<input type="text" class="prestation-unit" placeholder="ex : forfait, heure, unit√©">' +
                '</div>' +
                '<div>' +
                    '<label>Prix HT</label>' +
                    '<input type="number" class="prestation-price" value="0" min="0" step="0.01" onchange="onPriceChange(this)">' +
                '</div>' +
                '<div class="purchase-wrapper" style="display:none;">' +
                    '<label style="margin-top:6px;font-size:12px;">Prix d\'achat</label>' +
                    '<input type="number" class="prestation-purchase" value="" min="0" step="0.01" oninput="onPurchaseChange(this)">' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<div class="form-group">' +
            '<label>Total</label>' +
            '<input type="text" class="prestation-total" readonly>' +
        '</div>' +
        '<div class="form-group no-print">' +
            '<label>&nbsp;</label>' +
            '<button type="button" class="btn btn-danger btn-small" onclick="removePrestation(' + prestationCount + ')">üóëÔ∏è</button>' +
        '</div>';

    container.appendChild(line);
    calculateTotals();
}


// üîπ Fonction s√©par√©e, en dehors de addPrestation
function removePrestation(id) {
    const line = document.getElementById("prestation-" + id);
    if (!line) return;

    // On √©vite de supprimer la ligne sp√©ciale d√©placement
    if (line.id === "deplacementContainer") return;

    line.remove();
    calculateTotals();
}

function getCurrentClientType() {
    const part = document.getElementById("clientParticulier");
    const syn  = document.getElementById("clientSyndic");

    if (syn && syn.checked) {
        return "syndic";
    }
    return "particulier";
}

function applyTemplate(selectEl) {
    const index = parseInt(selectEl.value, 10);
    const line = selectEl.closest(".prestation-line");
    if (!line || isNaN(index) || index < 0 || index >= PRESTATION_TEMPLATES.length) return;

    const template   = PRESTATION_TEMPLATES[index];
    const clientType = getCurrentClientType();

    line.dataset.kind = template.kind || "";

    const descInput  = line.querySelector(".prestation-desc");
    const qtyInput   = line.querySelector(".prestation-qty");
    const priceInput = line.querySelector(".prestation-price");
    const unitInput  = line.querySelector(".prestation-unit");

    // Description d√©taill√©e pour le PDF
    const detailHidden = clientType === "particulier"
        ? template.descParticulier
        : template.descSyndic;
    line.dataset.detail = detailHidden || "";
    // ---------- Unit√© par d√©faut selon le type ----------
if (unitInput) {
    let unitVal = "";
    if (template.kind === "depannage_clim" ||
        template.kind === "depannage_piscine" ||
        template.kind === "depannage_jacuzzi") {
        unitVal = "heure";
    } else if (template.kind === "produits" || template.kind === "fournitures") {
        unitVal = "unit√©";
    } else {
        unitVal = "forfait";
    }
    unitInput.value = unitVal;
}


    // ---------- Intitul√© ----------
    if (descInput) {
        if (template.kind === "produits" || template.kind === "fournitures") {
            // üî• Tu remplis toi-m√™me, on laisse VIDE
            descInput.value = "";
        } else {
            let title = template.title || template.label || "";

            // Cas sp√©cial entretien clim : pluriel
            if (template.kind === "entretien_clim") {
                const qty    = qtyInput ? (parseFloat(qtyInput.value) || 1) : 1;
                const plural = qty >= 2 ? "s" : "";
                title = "Forfait entretien climatisation" + plural;
            }

            descInput.value = title;
        }
    }

    // ---------- Prix selon type de client ----------
    if (priceInput) {
        let price = 0;
        if (clientType === "syndic") {
            price = template.priceSyndic || 0;
        } else {
            price = template.priceParticulier || 0;
        }
        priceInput.value       = price.toFixed(2);
        line.dataset.basePrice = price.toFixed(2);
    }

    // Quantit√© par d√©faut
    if (qtyInput) qtyInput.value = 1;

    // üîπ Met √† jour visibilit√© prix d'achat + note suivant le kind
    updatePurchaseVisibility(line);

    calculateTotals();
}

function onPriceChange(input) {
    const line = input.closest(".prestation-line");
    if (line) {
        // on garde la valeur saisie comme base
        line.dataset.basePrice = input.value || "0";

        // üîπ si c'est une ligne entretien clim, on d√©sactive le calcul auto
        if (line.dataset.kind === "entretien_clim") {
            line.dataset.autoPrice = "0";  // => cette ligne ne sera plus recalcul√©e
        }
    }
    calculateTotals();
}

const MARGIN_MULTIPLIER = 1.4;

function onPurchaseChange(input) {
    const line = input.closest(".prestation-line");
    if (!line) return;

    // On ne l‚Äôapplique que pour Produits / Fournitures
    const kind = line.dataset.kind || "";
    if (kind !== "produits" && kind !== "fournitures") {
        return;
    }

    const purchase = parseFloat(input.value) || 0;
    const priceInput = line.querySelector(".prestation-price");
    if (!priceInput) return;

    if (purchase > 0) {
        const sale = purchase * MARGIN_MULTIPLIER;
        priceInput.value = sale.toFixed(2);
        line.dataset.basePrice = priceInput.value; // coh√©rent avec onPriceChange
    } else {
        priceInput.value = "0.00";
        line.dataset.basePrice = "0";
    }

    calculateTotals();
}

function updatePurchaseVisibility(line) {
    const wrap = line.querySelector(".purchase-wrapper");
    if (!wrap) return;

    const kind = line.dataset.kind || "";
    if (kind === "produits" || kind === "fournitures") {
        wrap.style.display = "block";
    } else {
        wrap.style.display = "none";
        const purchaseInput = line.querySelector(".prestation-purchase");
        if (purchaseInput) purchaseInput.value = "";
    }
}



function calculateTotals() {
    const lines = document.querySelectorAll(".prestation-line");
    let subtotal = 0;

    lines.forEach(line => {
        const qtyInput   = line.querySelector(".prestation-qty");
        const priceInput = line.querySelector(".prestation-price");
        const descInput  = line.querySelector(".prestation-desc");
        if (!qtyInput || !priceInput) return;

        let qty   = parseFloat(qtyInput.value)  || 0;
        let price = parseFloat(priceInput.value) || 0;
        const kind      = line.dataset.kind || "";
        const autoPrice = line.dataset.autoPrice !== "0";  // true = auto, false = manuel

        // -------- Entretien clim : titre dynamique + √©ventuellement tarif auto --------
        if (kind === "entretien_clim") {
            const n = qty <= 0 ? 1 : qty;

            // Met √† jour l'intitul√© avec ou sans "s"
            if (descInput) {
                const plural = n >= 2 ? "s" : "";
                descInput.value = "Forfait entretien climatisation" + plural;
            }

            const clientType = getCurrentClientType(); // "particulier" ou "syndic"

            if (autoPrice) {
                if (clientType === "syndic") {
                    if (n <= 1)       price = 110; // 1 clim
                    else if (n === 2) price = 90;  // 2 clims
                    else              price = 80;  // 3+ clims
                } else {
                    if (n <= 1)       price = 90; // 1 clim
                    else if (n === 2) price = 75; // 2 clims
                    else              price = 65; // 3+ clims
                }
                priceInput.value = price.toFixed(2);
            } else {
                price = parseFloat(priceInput.value) || 0;
            }
        }



        // -------- Total par ligne --------
        const total = qty * price;
        const totField = line.querySelector(".prestation-total");
        if (totField) totField.value = formatEuro(total);
        subtotal += total;
    });

    // -------- R√©duction en % --------
    const discountCb         = document.getElementById("discountEnabled");
    const discountInput      = document.getElementById("discountPercentInput");
    const discountLine       = document.getElementById("discountLine");
    const discountAmountSpan = document.getElementById("discountAmount");
    const discountLabel      = document.getElementById("discountLabel");

    let discountRate   = 0;
    let discountAmount = 0;

    if (discountCb && discountInput && discountCb.checked) {
        discountRate = parseFloat(discountInput.value) || 0;
        if (discountRate < 0)   discountRate = 0;
        if (discountRate > 100) discountRate = 100;
        discountInput.value = discountRate;
        discountAmount = subtotal * (discountRate / 100);
    }

    let subtotalAfterDiscount = subtotal - discountAmount;
    if (subtotalAfterDiscount < 0) subtotalAfterDiscount = 0;

    if (discountLine && discountAmountSpan && discountLabel) {
        if (discountCb && discountRate > 0 && discountAmount > 0) {
            discountLine.style.display = "flex";
            discountLabel.textContent =
                "R√©duction (" + discountRate.toFixed(2).replace(/\.00$/,"") + " %) :";
            discountAmountSpan.textContent = "- " + formatEuro(discountAmount);
        } else {
            discountLine.style.display = "none";
        }
    }

    // -------- TVA sur le montant apr√®s r√©duction --------
    const tvaRate   = parseFloat(document.getElementById("tvaRate").value) || 0;
    const tvaAmount = subtotalAfterDiscount * (tvaRate / 100);
    const totalTTC  = subtotalAfterDiscount + tvaAmount;

    document.getElementById("subtotalHT").textContent = formatEuro(subtotal);
    document.getElementById("tvaAmount").textContent  = formatEuro(tvaAmount);
    document.getElementById("totalTTC").textContent   = formatEuro(totalTTC);

    // -------- Libell√© du total (TOTAL √Ä PAYER / TOTAL HT / TOTAL TTC) --------
    const totalLabelEl = document.getElementById("totalLabel");
    if (totalLabelEl) {
        const clientType = getCurrentClientType(); // "particulier" ou "syndic"

        if (tvaRate === 0) {
            if (clientType === "syndic") {
                totalLabelEl.textContent = "TOTAL HT :";
            } else {
                totalLabelEl.textContent = "NET √Ä PAYER :";
            }
        } else {
            totalLabelEl.textContent = "TOTAL TTC :";
        }
    }
}



    // ------- Conditions de r√®glement + ajustement prix client -------

function onClientTypeChange() {
    const clientType = getCurrentClientType();

    const lines = document.querySelectorAll(".prestation-line");
    lines.forEach(line => {
        const selectEl   = line.querySelector(".prestation-template");
        const descInput  = line.querySelector(".prestation-desc");
        const priceInput = line.querySelector(".prestation-price");
        const qtyInput   = line.querySelector(".prestation-qty");

        if (!selectEl) return;
        const index = parseInt(selectEl.value, 10);
        if (isNaN(index) || index <= 0 || index >= PRESTATION_TEMPLATES.length) return;

        const template = PRESTATION_TEMPLATES[index];
        line.dataset.kind = template.kind || "";
updatePurchaseVisibility(line);


        // Description d√©taill√©e pour PDF
        const detailHidden = clientType === "particulier"
            ? template.descParticulier
            : template.descSyndic;
        line.dataset.detail = detailHidden || "";

        // Intitul√©
        if (descInput) {
            let title = template.title || template.label || "";

            if (template.kind === "entretien_clim") {
                const qty    = qtyInput ? (parseFloat(qtyInput.value) || 1) : 1;
                const plural = qty >= 2 ? "s" : "";
                title = "Forfait entretien climatisation" + plural;
            }

            descInput.value = title;
        }

        // Prix selon type client
        if (priceInput) {
            let price = 0;
            if (clientType === "syndic") {
                price = template.priceSyndic || 0;
            } else {
                price = template.priceParticulier || 0;
            }
            priceInput.value       = price.toFixed(2);
            line.dataset.basePrice = price.toFixed(2);
        }
    });

    calculateTotals();
}

function selectClientType(type) {
    const part = document.getElementById("clientParticulier");
    const syn  = document.getElementById("clientSyndic");

    if (type === "particulier") {
        if (part) part.checked = true;
        if (syn)  syn.checked  = false;
        setConditions('particulier');
    } else {
        if (syn)  syn.checked  = true;
        if (part) part.checked = false;
        setConditions('agence');
    }

    // Met √† jour les prix/descriptions selon le type client
    onClientTypeChange();

    // Relance setTVA avec le taux actuellement s√©lectionn√©
    const tvaInput = document.getElementById("tvaRate");
    const rate = tvaInput ? (parseFloat(tvaInput.value) || 0) : 0;
    setTVA(rate); // setTVA fera aussi calculateTotals()
}

function setConditions(type) {
    const notesEl = document.getElementById("notes");
    const cbClientPart = document.getElementById("clientParticulier");
    const cbClientSyn  = document.getElementById("clientSyndic");

    if (type === "particulier") {
        if (cbClientPart) cbClientPart.checked = true;
        if (cbClientSyn)  cbClientSyn.checked  = false;

        if (notesEl) {
            notesEl.value =
                "R√®glement √† r√©ception de facture.\n" +
                "Aucun escompte pour paiement anticip√©.\n" +
                "En cas de retard de paiement : p√©nalit√©s au taux l√©gal en vigueur et indemnit√© forfaitaire de 40 ‚Ç¨ pour frais de recouvrement (article L441-10 du Code de commerce).";
        }
    } else if (type === "agence") {
        if (cbClientSyn)  cbClientSyn.checked  = true;
        if (cbClientPart) cbClientPart.checked = false;

        if (notesEl) {
            notesEl.value =
                "Paiement √† 30 jours date de facture.\n" +
                "Aucun escompte pour paiement anticip√©.\n" +
                "P√©nalit√©s de retard : taux l√©gal en vigueur et indemnit√© forfaitaire de 40 ‚Ç¨ pour frais de recouvrement (article L441-10 du Code de commerce).";
        }
    }

    // On recalcule les prix / descriptions selon le type de client
    onClientTypeChange();

    // On rafra√Æchit les libell√©s de TVA / total avec le taux actuel
    const tvaInput = document.getElementById("tvaRate");
    const currentRate = tvaInput ? (parseFloat(tvaInput.value) || 0) : 0;
    setTVA(currentRate);
}



    // ------- New document -------
    function newDocument(type) {
        currentDocumentId = null;
        document.getElementById("listView").classList.add("hidden");
        document.getElementById("formView").classList.remove("hidden");

        document.getElementById("docType").value = type;
        document.getElementById("clientName").value = "";
document.getElementById("clientAddress").value = "";
document.getElementById("clientPhone").value = "";
document.getElementById("clientEmail").value = "";
document.getElementById("notes").value = "";
        const subjectInput = document.getElementById("docSubject");
if (subjectInput) subjectInput.value = "";

// on utilise maintenant UNIQUEMENT les cases du haut
const cbClientPart = document.getElementById("clientParticulier");
const cbClientSyn  = document.getElementById("clientSyndic");
if (cbClientPart) cbClientPart.checked = true;   // par d√©faut : Particulier
if (cbClientSyn)  cbClientSyn.checked  = false;
setConditions('particulier'); // pour remplir les notes par d√©faut


        resetPaymentForm();

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("docDate").value = today;
        document.getElementById("docNumber").value = getNextNumber(type);

        const discountCb = document.getElementById("discountEnabled");
        const discountInput = document.getElementById("discountPercentInput");
        const discountLine = document.getElementById("discountLine");
        if (discountCb) discountCb.checked = false;
        if (discountInput) {
            discountInput.value = 0;
            discountInput.disabled = true;
        }
        if (discountLine) discountLine.style.display = "none";

        setTVA(0);
        updateDocType();
        updateTransformButtonVisibility();

        prestationCount = 0;
        document.getElementById("prestationsContainer").innerHTML = "";
        addPrestation();

        document.getElementById("formTitle").textContent = type === "devis" ? "Nouveau devis" : "Nouvelle facture";
        calculateTotals();
    }

    // ------- Save / Load / Delete -------
function saveDocument() {
    const clientName    = document.getElementById("clientName").value.trim();
    const clientAddress = document.getElementById("clientAddress").value.trim();
    const clientPhone   = document.getElementById("clientPhone").value.trim();
    const clientEmail   = document.getElementById("clientEmail").value.trim();
    const docSubject    = (document.getElementById("docSubject")?.value || "").trim();

    // ‚úÖ V√©rif client
    if (!clientName || !clientAddress) {
        alert("Veuillez renseigner au minimum le nom et l'adresse du client.");
        return;
    }

    // ‚úÖ Objet obligatoire
    if (!docSubject) {
        alert("Veuillez saisir l'objet du devis / de la facture.");
        return;
    }

    // üîπ On r√©cup√®re TOUTES les lignes de prestations (y compris d√©placement)
    const prestations = [];
    document.querySelectorAll(".prestation-line").forEach(line => {
        const desc   = (line.querySelector(".prestation-desc")?.value || "").trim();
        const qty    = parseFloat(line.querySelector(".prestation-qty")?.value)   || 0;
        const price  = parseFloat(line.querySelector(".prestation-price")?.value) || 0;
        const unit   = (line.querySelector(".prestation-unit")?.value || "").trim();
        const note   = (line.querySelector(".prestation-note")?.value || "").trim();
        const detail = line.dataset.detail || "";
        const kind   = line.dataset.kind   || "";

        const datesInputs = line.querySelectorAll(".prestation-date");
        const dates = [];
        datesInputs.forEach(i => {
            const v = i.value.trim();
            if (v) dates.push(v);
        });

        if (desc) {
            prestations.push({
                desc,
                detail,
                qty,
                price,
                total: qty * price,
                unit,
                dates,
                note,
                kind
            });
        }
    });

    if (prestations.length === 0) {
        alert("Ajoutez au moins une prestation");
        return;
    }

    const docType      = document.getElementById("docType").value;
    const docNumber    = document.getElementById("docNumber").value;
    const docDate      = document.getElementById("docDate").value;
    const validityDate = document.getElementById("validityDate").value;
    const tvaRate      = parseFloat(document.getElementById("tvaRate").value) || 0;
    const notes        = document.getElementById("notes").value;
    const existing     = currentDocumentId ? getDocument(currentDocumentId) : null;

    let conditionsType = existing ? (existing.conditionsType || "") : "";

    // üîπ Type de client (cases du haut)
    const cbClientPart = document.getElementById("clientParticulier");
    const cbClientSyn  = document.getElementById("clientSyndic");

    if (cbClientPart && cbClientPart.checked) {
        conditionsType = "particulier";
    } else if (cbClientSyn && cbClientSyn.checked) {
        conditionsType = "agence";
    } else {
        conditionsType = "";
    }

    // üîπ Statut devis / facture
    let status = "";
    if (docType === "devis") {
        status = existing && existing.status ? existing.status : "en_attente";
    } else {
        status = existing && existing.status ? existing.status : "";
    }

    // üîπ Paiement (pour factures)
    let paymentMode = "";
    let paymentDate = "";
    let paid = false;

    if (docType === "facture") {
        const sel = document.querySelector('input[name="payMode"]:checked');
        if (sel && sel.value) {
            paymentMode = sel.value;
            const pdInput = document.getElementById("paymentDate");
            const pd = pdInput ? pdInput.value : "";
            paymentDate = pd || docDate;
        } else if (existing && existing.type === "facture") {
            paymentMode = existing.paymentMode || "";
            paymentDate = existing.paymentDate || "";
        }
        paid = paymentMode !== "";
    }

    // üîπ Totaux
    let subtotal = 0;
    prestations.forEach(p => subtotal += p.total);

    const discountCb    = document.getElementById("discountEnabled");
    const discountInput = document.getElementById("discountPercentInput");

    let discountRate   = 0;
    let discountAmount = 0;
    if (discountCb && discountInput && discountCb.checked) {
        discountRate = parseFloat(discountInput.value) || 0;
        if (discountRate < 0)   discountRate = 0;
        if (discountRate > 100) discountRate = 100;
        discountAmount = subtotal * (discountRate / 100);
    }

    let baseAfterDiscount = subtotal - discountAmount;
    if (baseAfterDiscount < 0) baseAfterDiscount = 0;

    const tvaAmount = baseAfterDiscount * (tvaRate / 100);
    const totalTTC  = baseAfterDiscount + tvaAmount;

    const doc = {
        id: currentDocumentId || Date.now().toString(),
        type: docType,
        number: docNumber,
        date: docDate,
        validityDate,
        subject: docSubject, // ‚úÖ UNE seule fois, propre
        client: {
            name: clientName,
            address: clientAddress,
            phone: clientPhone,
            email: clientEmail
        },
        prestations,
        tvaRate,
        subtotal,
        discountRate,
        discountAmount,
        tvaAmount,
        totalTTC,
        notes,
        paid,
        paymentMode,
        paymentDate,
        status,
        conditionsType,
        createdAt: existing ? existing.createdAt : new Date().toISOString()
    };

    const docs = getAllDocuments();
    const idx  = docs.findIndex(d => d.id === doc.id);
    if (idx >= 0) docs[idx] = doc;
    else docs.push(doc);
    saveDocuments(docs);

    alert("Document enregistr√© avec succ√®s !");
    currentDocumentId = doc.id;
    loadDocumentsList();
    updateTransformButtonVisibility();
}



function loadDocument(id) {
    const doc = getDocument(id);
    if (!doc) return;
    currentDocumentId = id;


    // Affichage formulaire
    document.getElementById("listView").classList.add("hidden");
    document.getElementById("formView").classList.remove("hidden");

    // Remplissage des champs principaux
    document.getElementById("docType").value = doc.type;
    document.getElementById("docNumber").value = doc.number;
    document.getElementById("docDate").value = doc.date;
    document.getElementById("validityDate").value = doc.validityDate || "";
    document.getElementById("clientName").value = doc.client.name;
    document.getElementById("clientAddress").value = doc.client.address;
    document.getElementById("clientPhone").value = doc.client.phone;
    document.getElementById("clientEmail").value = doc.client.email;
    document.getElementById("notes").value = doc.notes || "";
    const subjectInput = document.getElementById("docSubject");
if (subjectInput) {
    subjectInput.value = doc.subject || "";
}


    // Type de client (Particulier / Syndic)
    const cbClientPart = document.getElementById("clientParticulier");
    const cbClientSyn  = document.getElementById("clientSyndic");
    if (cbClientPart && cbClientSyn) {
        cbClientPart.checked = doc.conditionsType === "particulier";
        cbClientSyn.checked  = doc.conditionsType === "agence";
    }

    onClientTypeChange();

    // Paiement si facture
    resetPaymentForm();
    if (doc.type === "facture") {
        if (doc.paymentMode) {
            const modeId =
                doc.paymentMode === "especes"  ? "payEspeces" :
                doc.paymentMode === "cb"       ? "payCB" :
                doc.paymentMode === "virement" ? "payVirement" :
                doc.paymentMode === "cheque"   ? "payCheque" :
                "payNone";
            const el = document.getElementById(modeId);
            if (el) el.checked = true;
        }
        const dateEl = document.getElementById("paymentDate");
        if (dateEl) dateEl.value = doc.paymentDate || "";
        onPayModeChange();
    }

    // TVA / devis expir√© / bouton transformer
    setTVA(doc.tvaRate === 20 ? 20 : 0);
    updateDocType();
    updateTransformButtonVisibility();
    refreshDevisStatusUI(doc.type, doc.validityDate || "");

    // R√©duction
    const discountCb = document.getElementById("discountEnabled");
    const discountInput = document.getElementById("discountPercentInput");
    const discountLine = document.getElementById("discountLine");
    const discRate = doc.discountRate != null ? doc.discountRate : 0;
    if (discountCb && discountInput) {
        if (discRate > 0) {
            discountCb.checked = true;
            discountInput.disabled = false;
            discountInput.value = discRate;
            if (discountLine) discountLine.style.display = "flex";
        } else {
            discountCb.checked = false;
            discountInput.disabled = true;
            discountInput.value = 0;
            if (discountLine) discountLine.style.display = "none";
        }
    }

    // Prestations
    prestationCount = 0;
    const prestationsContainer = document.getElementById("prestationsContainer");
    prestationsContainer.innerHTML = "";
    doc.prestations.forEach(p => {
        addPrestation();
        const lines = document.querySelectorAll(".prestation-line");
        const line = lines[lines.length - 1];
        line.dataset.kind = p.kind || "";
        line.dataset.detail = p.detail || "";
        line.dataset.basePrice = (p.price || 0).toFixed(2);
updatePurchaseVisibility(line);


        const descInput = line.querySelector(".prestation-desc");
const qtyInput = line.querySelector(".prestation-qty");
const priceInput = line.querySelector(".prestation-price");
const unitInput = line.querySelector(".prestation-unit");

descInput.value = p.desc;
qtyInput.value = p.qty;
priceInput.value = p.price;
if (unitInput) unitInput.value = p.unit || "";


        const note = line.querySelector(".prestation-note");
        if (p.note && note) {
            note.value = p.note;
            note.classList.remove("hidden");
        }

        const datesContainer = line.querySelector(".prestation-dates");
        datesContainer.innerHTML = "";
        if (p.dates && p.dates.length) {
            p.dates.forEach(dv => {
                const inp = document.createElement("input");
                inp.type = "text";
                inp.className = "prestation-date";
                inp.value = dv;
                datesContainer.appendChild(inp);
            });
        } else {
            const inp = document.createElement("input");
            inp.type = "text";
            inp.className = "prestation-date";
            inp.placeholder = "JJ/MM/AAAA";
            datesContainer.appendChild(inp);
        }
    });

    calculateTotals();
    document.getElementById("formTitle").textContent =
        (doc.type === "devis" ? "Devis " : "Facture ") + doc.number;
}

 function deleteCurrent() {
    if (!currentDocumentId) return;
    if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce document ?")) return;

    const idToDelete = currentDocumentId;

    const docs = getAllDocuments().filter(d => d.id !== idToDelete);
    saveDocuments(docs); // met √† jour local + Firestore pour les docs restants

    // Suppression du document dans Firestore
    if (db) {
        db.collection("documents")
          .doc(idToDelete)
          .delete()
          .catch(err => console.error("Erreur Firestore delete :", err));
    }

    alert("Document supprim√©");
    backToList();
}


    function backToList() {
        document.getElementById("formView").classList.add("hidden");
        document.getElementById("listView").classList.remove("hidden");
        currentDocumentId = null;
        loadYearFilter();
        loadDocumentsList();
        updateTransformButtonVisibility();
    }

    // ------- Liste + statut devis / factures -------
    function loadDocumentsList() {
        const docs = getAllDocuments();
        let filtered = docs.filter(d => d.type === currentListType);
        if (currentListType === "facture") {
            const yearSel = document.getElementById("yearFilter");
            if (yearSel && yearSel.value !== "all") {
                const y = parseInt(yearSel.value, 10);
                filtered = filtered.filter(d => d.date && new Date(d.date).getFullYear() === y);
            }
        }

        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        const tbody = document.getElementById("documentsTableBody");
        tbody.innerHTML = "";
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">Aucun document pour le moment</td></tr>';
            return;
        }

        filtered.forEach(doc => {
            const tr = document.createElement("tr");
            const typeLabel = doc.type === "devis" ? "Devis" : "Facture";
            const badgeClass = doc.type === "devis" ? "badge-devis" : "badge-facture";

            let statutHTML = "";

            if (doc.type === "facture") {
                const checked = doc.paid ? "checked" : "";
                const mode = doc.paymentMode || "";
                const modeLabel =
                    mode === "especes" ? "Esp√®ces" :
                    mode === "cb" ? "CB" :
                    mode === "virement" ? "Virement" :
                    mode === "cheque" ? "Ch√®que" : "";
                const badgeStatus = doc.paid ? "badge-paid" : "badge-unpaid";
                const statusText = doc.paid
                    ? ("üü¢ Pay√©e" + (modeLabel ? " (" + modeLabel + ")" : ""))
                    : "üî¥ Non pay√©e";

                statutHTML =
                    '<span class="badge ' + badgeStatus + '">' + statusText + '</span><br>' +
                    '<label style="font-size:11px;"><input type="checkbox" onchange="togglePaid(\'' + doc.id + '\', this)" ' + checked + '> Marquer pay√©e</label>' +
                    '<div style="font-size:11px;margin-top:4px;white-space:nowrap;">' +
                        '<label><input type="radio" name="mode-' + doc.id + '" value="especes" ' + (mode === "especes" ? "checked" : "") + ' onchange="setPaymentMode(\'' + doc.id + '\', \'especes\')"> Esp√®ces</label> ' +
                        '<label><input type="radio" name="mode-' + doc.id + '" value="cb" ' + (mode === "cb" ? "checked" : "") + ' onchange="setPaymentMode(\'' + doc.id + '\', \'cb\')"> CB</label> ' +
                        '<label><input type="radio" name="mode-' + doc.id + '" value="virement" ' + (mode === "virement" ? "checked" : "") + ' onchange="setPaymentMode(\'' + doc.id + '\', \'virement\')"> Virement</label> ' +
                        '<label><input type="radio" name="mode-' + doc.id + '" value="cheque" ' + (mode === "cheque" ? "checked" : "") + ' onchange="setPaymentMode(\'' + doc.id + '\', \'cheque\')"> Ch√®que</label>' +
                    '</div>';
            } else {
                let storedStatus = doc.status || "en_attente";
                let displayStatus = storedStatus;
                if (isDevisExpired("devis", doc.validityDate) && storedStatus === "en_attente") {
                    displayStatus = "expire";
                }

                let badgeDevisClass = "badge-devis-en-attente";
                let text = "En attente";
                if (displayStatus === "accepte") {
                    badgeDevisClass = "badge-devis-accepte";
                    text = "Accept√©";
                } else if (displayStatus === "refuse") {
                    badgeDevisClass = "badge-devis-refuse";
                    text = "Refus√©";
                } else if (displayStatus === "expire") {
                    badgeDevisClass = "badge-devis-expire";
                    text = "Expir√©";
                }

                const selectHtml =
                    '<select style="font-size:11px;margin-top:4px;" onchange="setDevisStatus(\'' + doc.id + '\', this.value)">' +
                        '<option value="en_attente"' + (storedStatus === "en_attente" ? " selected" : "") + '>En attente</option>' +
                        '<option value="accepte"' + (storedStatus === "accepte" ? " selected" : "") + '>Accept√©</option>' +
                        '<option value="refuse"' + (storedStatus === "refuse" ? " selected" : "") + '>Refus√©</option>' +
                        '<option value="expire"' + (storedStatus === "expire" ? " selected" : "") + '>Expir√©</option>' +
                    '</select>';

                statutHTML =
                    '<span class="badge ' + badgeDevisClass + '">' + text + '</span><br>' +
                    selectHtml;
            }

           let actionsHtml =
    '<div class="actions-btns">' +
        '<button class="btn btn-primary btn-small" type="button" onclick="loadDocument(\'' + doc.id + '\')">Ouvrir</button>' +
        '<button class="btn btn-primary btn-small" type="button" onclick="openPrintable(\'' + doc.id + '\')">Imprimer</button>' +
    '</div>';

            tr.innerHTML =
                '<td><span class="badge ' + badgeClass + '">' + typeLabel + '</span></td>' +
                '<td>' + doc.number + '</td>' +
                '<td>' + (doc.client?.name || "") + '</td>' +
                '<td>' + (doc.date ? new Date(doc.date).toLocaleDateString("fr-FR") : "") + '</td>' +
                '<td><strong>' + formatEuro(doc.totalTTC) + '</strong></td>' +
                '<td class="status-cell">' + statutHTML + '</td>' +
                '<td>' + actionsHtml + '</td>';
            tbody.appendChild(tr);
        });
    }

    function togglePaid(id, checkbox) {
        const docs = getAllDocuments();
        const doc = docs.find(d => d.id === id);
        if (!doc) return;
        if (checkbox.checked) {
            doc.paid = true;
            if (!doc.paymentMode) {
                doc.paymentMode = "especes";
                doc.paymentDate = doc.date;
            }
        } else {
            doc.paid = false;
            doc.paymentMode = "";
            doc.paymentDate = "";
        }
        saveDocuments(docs);
        loadDocumentsList();
    }

    function setPaymentMode(id, mode) {
        const docs = getAllDocuments();
        const doc = docs.find(d => d.id === id);
        if (!doc) return;
        doc.paymentMode = mode;
        doc.paid = true;
        if (mode === "virement" || mode === "cheque") {
            doc.paymentDate = doc.paymentDate || doc.date;
        } else {
            doc.paymentDate = doc.date;
        }
        saveDocuments(docs);
        loadDocumentsList();
    }

    function setDevisStatus(id, status) {
        const docs = getAllDocuments();
        const doc = docs.find(d => d.id === id);
        if (!doc || doc.type !== "devis") return;
        doc.status = status;
        saveDocuments(docs);
        loadDocumentsList();
    }

    // ------- Transformer devis -> facture -------
    function transformToInvoice() {
        if (!currentDocumentId) {
            alert("Ouvrez d'abord un devis pour le transformer.");
            return;
        }
        const devis = getDocument(currentDocumentId);
        if (!devis || devis.type !== "devis") {
            alert("Ce document n'est pas un devis.");
            return;
        }
        const docs = getAllDocuments();
        const facture = JSON.parse(JSON.stringify(devis));
        facture.id = Date.now().toString();
        facture.type = "facture";
        facture.number = getNextNumber("facture");
        facture.date = new Date().toISOString().split("T")[0];
        facture.validityDate = "";
        facture.paid = false;
        facture.paymentMode = "";
        facture.paymentDate = "";
        facture.status = "";
        facture.createdAt = new Date().toISOString();
        docs.push(facture);
        saveDocuments(docs);
        alert("Devis transform√© en facture : " + facture.number);
        loadDocument(facture.id);
    }

    // ------- Export CSV factures -------
    function exportFacturesCSV() {
        const docs = getAllDocuments().filter(d => d.type === "facture");
        if (docs.length === 0) {
            alert("Aucune facture √† exporter.");
            return;
        }
        let csv = "Numero;Date;Client;MontantHT;TVA;MontantTotal;Statut;DateReglement;ModeReglement\n";
        docs.forEach(d => {
            const dateStr = d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "";
            const statut = d.paid ? "Facture pay√©e" : "Non pay√©e";
            const dateReg = d.paymentDate
                ? new Date(d.paymentDate).toLocaleDateString("fr-FR")
                : (d.paid && d.date ? new Date(d.date).toLocaleDateString("fr-FR") : "");
            const mode = d.paymentMode || "";
            csv += [
                d.number,
                dateStr,
                (d.client?.name || "").replace(/;/g, ","),
                d.subtotal.toFixed(2),
                d.tvaAmount.toFixed(2),
                d.totalTTC.toFixed(2),
                statut,
                dateReg,
                mode
            ].join(";") + "\n";
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "factures_aquaclim_prestige.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

// ------- Impression / PDF -------
function openPrintable(id) {
    const targetId = id || currentDocumentId;
    if (!targetId) {
        alert("Veuillez d'abord enregistrer le document");
        return;
    }
    const doc = getDocument(targetId);
    if (!doc) return;

    // ---------- D√©tection piscine / clim / produits / d√©placement ----------
    const hasPiscine = doc.prestations.some(p =>
        [
            "piscine_chlore",
            "piscine_sel",
            "hivernage_piscine",
            "remise_service_piscine",
            "traitement_choc",
            "changement_sable",
            "remplacement_roulement",
            "remplacement_pompe_mo",
            "remplacement_cellule_mo",
            "depannage_piscine"
        ].includes(p.kind)
    );

    const hasClim = doc.prestations.some(p =>
        [
            "entretien_clim",
            "depannage_clim"
        ].includes(p.kind)
    );

    const hasProduitsOuFournitures = doc.prestations.some(p =>
        p.kind === "produits" || p.kind === "fournitures"
    );

    const hasDeplacement = doc.prestations.some(p =>
        p.kind === "deplacement" || p.kind === "forfait_deplacement"
    );

    const isDevis        = doc.type === "devis";
    const isPaidInvoice  = (!isDevis && doc.paid);
    const isUnpaidInvoice = (!isDevis && !doc.paid);

    // ---------- Couleur dynamique pour le num√©ro du document ----------
const titleColor = isDevis
    ? "#1a74d9"                 // Devis = bleu
    : (doc.paid ? "#1b5e20"     // Facture pay√©e = vert
                : "#1a74d9");  // Facture non pay√©e = bleu


    // ---------- Helper format prix FR ----------
    const formatEuroFR = (value) => {
        const v = Number(value) || 0;
        return v.toLocaleString("fr-FR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + " ‚Ç¨";
    };

    // ---------- Lignes prestations ----------
    let prestationsHTML = "";
    doc.prestations.forEach(p => {
        let extraHtml = "";
        if (p.note || (p.dates && p.dates.length)) {
            extraHtml += `<div class="sub-info">`;
            if (p.note) {
                extraHtml += `<div class="sub-info-line">${p.note}</div>`;
            }
            if (p.dates && p.dates.length) {
                extraHtml += `<div class="sub-info-line"><span class="dates-label">Dates de passage :</span></div>`;
                p.dates.forEach(dv => {
                    extraHtml += `<div class="sub-info-line">${dv}</div>`;
                });
            }
            extraHtml += `</div>`;
        }

        const detailHtml = p.detail
            ? `<div class="desc-detail">${p.detail}</div>`
            : "";

        const qtyText = p.qty;

        let unitText = p.unit || "";
        if (!unitText) {
            if (p.kind === "depannage_clim" || p.kind === "depannage_piscine" || p.kind === "depannage_jacuzzi") {
                unitText = "heure";
            } else if (p.kind === "produits" || p.kind === "fournitures") {
                unitText = "unit√©";
            } else {
                unitText = "forfait";
            }
        }

        const priceText = formatEuroFR(p.price);
        const totalText = formatEuroFR(p.total);

        prestationsHTML += `
            <tr>
                <td>
                    <div class="desc-main">${p.desc}</div>
                    ${detailHtml}
                    ${extraHtml}
                </td>
                <td class="qty-col">${qtyText}</td>
                <td class="unit-col">${unitText}</td>
                <td class="price-col text-right">${priceText}</td>
                <td class="total-col text-right"><strong>${totalText}</strong></td>
            </tr>
        `;
    });

    // ---------- Bloc Informations importantes (pour devis) ----------
    let importantHtml = "";
    if (isDevis) {
        const items = [];

        if (hasPiscine && !hasProduitsOuFournitures) {
            items.push(
                "Les produits de traitement piscine (chlore choc, sel, produits d‚Äô√©quilibrage, etc.) " +
                "ne sont pas inclus, sauf mention contraire sur le devis, et seront factur√©s en suppl√©ment le cas √©ch√©ant."
            );
        }

        if (hasPiscine && hasClim) {
            items.push(
                "Les tarifs des pi√®ces d√©tach√©es de piscine et de climatisation " +
                "(pompes, cellules, cartes √©lectroniques, moteurs, etc.) sont susceptibles d‚Äô√©voluer en fonction " +
                "des tarifs fournisseurs en vigueur. Le montant final pourra √™tre ajust√© apr√®s votre accord."
            );
        } else if (hasPiscine) {
            items.push(
                "Les tarifs des pi√®ces d√©tach√©es de piscine (pompes, cellules, roulements, etc.) " +
                "sont susceptibles d‚Äô√©voluer selon les tarifs fournisseurs en vigueur. Le montant final pourra √™tre " +
                "ajust√© apr√®s votre accord."
            );
        } else if (hasClim) {
            items.push(
                "Les tarifs des pi√®ces d√©tach√©es de climatisation (moteurs, ventilateurs, cartes √©lectroniques, etc.) " +
                "sont susceptibles d‚Äô√©voluer selon les tarifs fournisseurs en vigueur. Le montant final pourra √™tre " +
                "ajust√© apr√®s votre accord."
            );
        }

        items.push(
            "Les prix indiqu√©s comprennent la main-d‚Äô≈ìuvre et, le cas √©ch√©ant, les frais de d√©placement mentionn√©s au devis."
        );

        items.push(
            "Toute prestation non mentionn√©e dans le pr√©sent devis fera l‚Äôobjet d‚Äôun devis compl√©mentaire " +
            "ou d‚Äôun avenant √©crit avant r√©alisation."
        );

        items.push(
            "L‚Äôentreprise est titulaire d‚Äôune assurance responsabilit√© civile professionnelle."
        );

        importantHtml = `
            <div class="important-block">
                <div class="important-title">Informations importantes</div>
                <ul>
                    ${items.map(t => `<li>${t}</li>`).join("")}
                </ul>
            </div>
        `;
    }

    // ---------- TVA & Totaux ----------
    const tvaRate          = doc.tvaRate || 0;
    const discountAmountDoc = doc.discountAmount || 0;
    const discountRateDoc   = doc.discountRate || 0;

    let tvaNoteHtml = "";
    if (tvaRate === 0) {
        tvaNoteHtml = `<div class="tva-note">TVA non applicable, article 293 B du CGI.</div>`;
    }

    let totalLabel = "";
    if (isDevis) {
        totalLabel = "Montant total :";
    } else if (tvaRate === 0) {
        if (doc.paid) {
            totalLabel = "NET PAY√â :";
        } else {
            totalLabel = "NET √Ä PAYER :";
        }
    } else {
        if (doc.paid) {
            totalLabel = "TOTAL PAY√â TTC :";
        } else {
            totalLabel = "TOTAL TTC :";
        }
    }

    const subtotalText       = formatEuroFR(doc.subtotal || 0);
    const discountAmountText = formatEuroFR(discountAmountDoc || 0);
    const tvaAmountText      = formatEuroFR(doc.tvaAmount || 0);
    const totalTTCText       = formatEuroFR(doc.totalTTC || 0);

    let totalsRows = `
        <tr>
            <td>Sous-total HT :</td>
            <td class="text-right">${subtotalText}</td>
        </tr>
    `;

    if (discountAmountDoc > 0 && discountRateDoc > 0) {
        const rateLabel = discountRateDoc.toFixed(2).replace(/\.00$/, "");
        totalsRows += `
            <tr>
                <td>R√©duction (${rateLabel} %) :</td>
                <td class="text-right">- ${discountAmountText}</td>
            </tr>
        `;
    }

    if (tvaRate > 0) {
        totalsRows += `
            <tr>
                <td>TVA (${tvaRate} %) :</td>
                <td class="text-right">${tvaAmountText}</td>
            </tr>
        `;
    }

    totalsRows += `
        <tr class="grand-total">
            <td>${totalLabel}</td>
            <td class="text-right">${totalTTCText}</td>
        </tr>
    `;

    // ---------- R√®glement / RIB / Notes ----------
    const dateStr = doc.date ? new Date(doc.date).toLocaleDateString("fr-FR") : "";
    const logoSrc = "https://raw.githubusercontent.com/Tzaneesh/Aquaclim-Prestige/main/logo.png";
    const signSrc = "https://raw.githubusercontent.com/Tzaneesh/Aquaclim-Prestige/main/signature.png";

    let reglementHtml = "";
    if (!isDevis && doc.paid && doc.paymentMode) {
        const payDate   = doc.paymentDate || doc.date;
        const payDateStr = payDate ? new Date(payDate).toLocaleDateString("fr-FR") : dateStr;
        let modePhrase = "";
        if (doc.paymentMode === "especes") modePhrase = "en esp√®ces";
        else if (doc.paymentMode === "cb") modePhrase = "par carte bancaire";
        else if (doc.paymentMode === "virement") modePhrase = "par virement";
        else if (doc.paymentMode === "cheque") modePhrase = "par ch√®que";

        reglementHtml = `
            <div class="reglement-block">
                <div class="reg-title">R√®glement</div>
                <p>Facture r√©gl√©e ${modePhrase} le ${payDateStr}.</p>
            </div>
        `;
    }

    let ribHtml = "";
    if (!isDevis && !doc.paid) {
        ribHtml = `
            <div class="rib-block">
                <div class="rib-title">Coordonn√©es bancaires pour virement</div>
                <p>Titulaire : AquaClim Prestige ‚Äì Le Blevennec Lo√Øc</p>
                <p>Banque : Banque Fictive</p>
                <p>IBAN : FR76 1234 5678 9012 3456 7890 123</p>
                <p>BIC : FICTFRPPXXX</p>
            </div>
        `;
    }

    // ---------- Conditions de r√®glement ----------
    let notesHtml = "";

    if (isDevis) {
        const devisConditions =
            "Paiement √† r√©ception de facture.\n" +
            "Aucun acompte demand√© sauf mention contraire.";

        notesHtml = `
            <div class="conditions-block">
                <div class="conditions-title">Conditions de r√®glement</div>
                <p>${devisConditions.replace(/\n/g, "<br>")}</p>
            </div>
        `;
    } else {
        let notesText = doc.notes || "";

        if (doc.paid && notesText) {
            const removeLines = [
                "Paiement √† 30 jours date de facture.",
                "R√®glement √† r√©ception de facture.",
                "Aucun escompte pour paiement anticip√©.",
                "En cas de retard de paiement : p√©nalit√©s au taux l√©gal en vigueur et indemnit√© forfaitaire de 40 ‚Ç¨ pour frais de recouvrement (article L441-10 du Code de commerce).",
                "P√©nalit√©s de retard : taux l√©gal en vigueur et indemnit√© forfaitaire de 40 ‚Ç¨ pour frais de recouvrement (article L441-10 du Code de commerce)."
            ];
            removeLines.forEach(line => {
                notesText = notesText.replace(line + "\n", "");
                notesText = notesText.replace(line, "");
            });
            notesText = notesText.trim();
        }

        notesHtml = notesText
            ? `
                <div class="conditions-block">
                    <div class="conditions-title">Conditions de r√®glement</div>
                    <p>${notesText.replace(/\n/g, "<br>")}</p>
                </div>
            `
            : "";
    }

    // ---------- Bloc Date / Validit√© / Lieu ----------
    const validityStr = (isDevis && doc.validityDate)
        ? new Date(doc.validityDate).toLocaleDateString("fr-FR")
        : "";

    let topDatesHtml = `
        <div class="doc-info-block">
            <div class="doc-info-row">
                <span class="doc-info-label">Date d‚Äô√©mission :</span>
                <span class="doc-info-value">${dateStr}</span>
            </div>
            ${validityStr ? `
            <div class="doc-info-row">
                <span class="doc-info-label">Validit√© :</span>
                <span class="doc-info-value">${validityStr}</span>
            </div>` : ``}
            <div class="doc-info-row">
                <span class="doc-info-label">Lieu d‚Äô√©mission :</span>
                <span class="doc-info-value">Nice</span>
            </div>
        </div>
    `;

    const signatureClientTitle = isDevis ? "Bon pour accord" : "Pour acquit";
    const signatureClientText = isDevis
        ? "Pr√©c√©d√© de la mention manuscrite : ¬´ Bon pour accord, lu et approuv√© ¬ª."
        : "Le client reconna√Æt avoir re√ßu la facture et en avoir pris connaissance.";

    const printWindow = window.open("", "_blank");

    const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>${isDevis ? "Devis " : "Facture "}${doc.number}</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            margin:0;
            padding:0;
            font-family:Arial,sans-serif;
            color:#333;
            font-size:10.5px;
        }
        .page{
            display:flex;
            flex-direction:column;
            min-height:100vh;
            padding:10mm 12mm 14mm 12mm;
            box-sizing:border-box;
        }
        .page-main{flex:1 0 auto;}
        .page-footer{flex-shrink:0;margin-top:8mm;}
        .bottom-block{page-break-inside:avoid;break-inside:avoid;}

        .header{
            text-align:center;
            margin-bottom:8px;
            border-bottom:1.3px solid #1a74d9;
            padding-bottom:7px;
        }
        img.logo{height:55px;margin-bottom:4px;}
        .header h1{
            color:#1a74d9;
            font-size:21px;
            margin-bottom:3px;
            font-weight:700;
        }
        .header p{
            color:#444;
            font-size:10.5px;
            line-height:1.25;
        }
        .subtitle{
            font-weight:600;
            font-size:11px;
        }
        .contact{
            font-size:10.5px;
            font-weight:500;
        }
        .contact strong{font-weight:700;}

        .doc-header-center{
            margin:10px 0 12px 0;
        }
        .doc-header-center h2{
            font-size:18px;
            color:#1a74d9;
            margin-top:10px;
            margin-bottom:4px;
            text-align:left;
        }
        .doc-subject{
            margin-top:6px;
            font-size:11px;
            font-weight:bold;
        }

        .doc-info-block{
            display:inline-block;
            border:1px solid #000;
            border-radius:6px;
            padding:6px 8px;
            font-size:10px;
            background:#fafafa;
        }
        .doc-info-row{
            display:flex;
            gap:4px;
            margin:1px 0;
        }
        .doc-info-label{
            min-width:95px;
            font-weight:bold;
        }
        .doc-info-value{
            flex:1;
        }

        .client-block{
            margin-bottom:8px;
            font-size:10px;
            border:1px solid #000;
            border-radius:6px;
            padding:8px 10px;
            background:#fff;
        }
 .client-title{
    font-weight:bold;
    font-size:10.5px;
    margin-bottom:4px;
    text-transform:none;  /* plus de majuscules forc√©es */
    letter-spacing:0;     /* plus d'espacement entre lettres */
}

        .client-line{
            margin:2px 0;
        }
        .client-label{
            font-weight:600;
            display:inline;
        }
        .client-value{
            display:inline;
            margin-left:4px;
        }

        .site-block{
            margin-bottom:8px;
            font-size:10px;
            border:1px solid #000;
            border-radius:6px;
            padding:8px 10px;
            background:#fff;
        }
        .site-title{
            font-weight:bold;
            font-size:10px;
            margin-bottom:4px;
            text-transform:uppercase;
            letter-spacing:0.5px;
        }

        table{
            width:100%;
            border-collapse:collapse;
            margin:10px 0;
        }
 th{
    background:#1a74d9;
    color:white;
    padding:6px 6px;
    text-align:left;
    font-weight:600;
    font-size:11px;
    border-bottom:2px solid #000; /* bordure noire */
}
td{
    padding:4px 6px;
    border-bottom:1px solid #000; /* bordure noire */
    font-size:10px;
    vertical-align:top;
}


        th:first-child,
        td:first-child{
            width:55%;
        }

        .text-right{text-align:right;}

        .qty-col,
        .unit-col{
            text-align:center;
            white-space:nowrap;
        }
        .price-col,
        .total-col{
            white-space:nowrap;
            text-align:right;
        }

        .desc-main{
            font-size:11px;
            font-weight:600;
            margin-bottom:2px;
        }
        .desc-detail{
            font-size:10px;
            color:#555;
            margin-top:2px;
        }
        .sub-info{
            margin-top:3px;
            font-size:9.5px;
            color:#555;
        }
        .sub-info-line{margin-top:1px;}

        .totals{
            margin-left:auto;
            width:230px;
            margin-top:6px;
            border:1px solid #000;
            border-radius:6px;
            padding:6px 8px;
            background:#fff;
        }
        .totals table{
            width:100%;
            border-collapse:collapse;
            margin:0;
        }
        .totals td{
            padding:3px 0;
            font-size:10px;
        }
        .totals .grand-total td{
            padding-top:5px;
            border-top:1px solid #000;
            font-weight:bold;
            font-size:11px;
            background:#f0f0f0;
        }
        .tva-note{
            margin-top:4px;
            font-size:9px;
            font-style:italic;
            color:#555;
        }

        .reglement-block{
            margin-top:6px;
            font-size:10px;
            border:1px solid #1b5e20;
            padding:8px;
            border-radius:6px;
            background:#e8f5e9;
            page-break-inside:avoid;
            break-inside:avoid;
        }
        .reg-title{
            font-weight:bold;
            margin-bottom:3px;
            color:#1b5e20;
            font-size:10px;
        }

        .rib-block{
            margin-top:6px;
            font-size:10px;
            border:1px solid #000;
            padding:8px;
            border-radius:6px;
            background:#fff;
            page-break-inside:avoid;
            break-inside:avoid;
        }
        .rib-title{
            font-weight:bold;
            margin-bottom:3px;
            font-size:10px;
        }

        .important-block{
            margin-top:8px;
            font-size:10px;
            border:1px solid #1a74d9;
            padding:8px;
            border-radius:6px;
            background:#f3f7ff;
            page-break-inside:avoid;
            break-inside:avoid;
        }
        .important-title{
            font-weight:bold;
            margin-bottom:4px;
            font-size:10px;
            color:#1a74d9;
        }
        .important-block ul{
            margin-left:14px;
        }
        .important-block li{
            margin-bottom:3px;
        }

        .conditions-block{
            margin-top:6px;
            font-size:10px;
            border:1px solid #000;
            border-radius:6px;
            padding:8px;
            background:#fff;
            page-break-inside:avoid;
            break-inside:avoid;
        }
        .conditions-title{
            font-weight:bold;
            margin-bottom:3px;
            font-size:10px;
        }

        .signatures{
            margin-top:10px;
            display:flex;
            justify-content:space-between;
            gap:22px;
            page-break-inside:avoid;
            break-inside:avoid;
        }
        .signature-block{
            flex:1;
            border-top:1px solid #333;
            padding-top:4px;
            font-size:10px;
            min-height:55px;
        }
        .signature-title{
            font-weight:bold;
            margin-bottom:3px;
        }
        img.sig{
            max-height:38px;
            margin-top:3px;
        }

        @media print{
            @page{margin:0;}
            body{margin:0;padding:0;}
            .page{min-height:100vh;}
        }
    </style>
</head>
<body>
<div class="page">
    <div class="page-main">
        <div class="header">
            <img src="${logoSrc}" class="logo" alt="AquaClim Prestige">
            <h1>AquaClim Prestige</h1>
            <p class="subtitle">Entretien & D√©pannage - Climatisations & Piscines</p>
            <p class="contact">
                Le Blevennec Lo√Øc ‚Äì 2 avenue Cauvin, 06100 Nice<br>
                T√©l : 06 03 53 77 73 ‚Äì Email : aquaclimprestige@gmail.com<br>
                SIRET : <strong>XXXXXXXXXXXXX</strong>
            </p>
        </div>

        <div class="doc-header-center">
            <h2 style="color:${titleColor};">
    ${isDevis ? "DEVIS N¬∞ : " : "FACTURE N¬∞ : "}${doc.number}
</h2>

            ${topDatesHtml}
            ${doc.subject ? `
                <div class="doc-subject">Objet : ${doc.subject}</div>
            ` : ``}
        </div>

  <div class="client-block">
    <div class="client-title">Client</div>

    ${doc.client?.name ? `
    <p class="client-line">${doc.client.name}</p>` : ""}

    ${doc.client?.address ? `
    <p class="client-line">${doc.client.address}</p>` : ""}

    ${doc.client?.phone ? `
    <p class="client-line">${doc.client.phone}</p>` : ""}

    ${doc.client?.email ? `
    <p class="client-line">${doc.client.email}</p>` : ""}
</div>


        ${doc.siteAddress && doc.siteAddress !== (doc.client?.address || "") ? `
        <div class="site-block">
            <div class="site-title">Lieu d‚Äôintervention</div>
            <p>${doc.siteAddress}</p>
        </div>
        ` : ""}

        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th class="qty-col">Quantit√©</th>
                    <th class="unit-col">Unit√©</th>
                    <th class="price-col text-right">Prix HT</th>
                    <th class="total-col text-right">Total HT</th>
                </tr>
            </thead>
            <tbody>
                ${prestationsHTML}
            </tbody>
        </table>

        <div class="totals">
            <table>
                ${totalsRows}
            </table>
            ${tvaNoteHtml}
        </div>

        ${isPaidInvoice ? reglementHtml : ""}
        ${isPaidInvoice ? notesHtml : ""}

    </div>

    <div class="page-footer bottom-block">
        ${
            isDevis
                ? `
                    ${notesHtml}
                    ${importantHtml}
                    <div class="signatures">
                        <div class="signature-block">
                            <div class="signature-title">${signatureClientTitle}</div>
                            <p>${signatureClientText}</p>
                            <p style="margin-top:6px;">Date :</p>
                            <p>Signature du client :</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-title">AquaClim Prestige</div>
                            <p>Signature et cachet de l‚Äôentreprise</p>
                            <img src="${signSrc}" class="sig" alt="Signature AquaClim Prestige">
                        </div>
                    </div>
                `
                : (
                    isUnpaidInvoice
                        ? `
                            ${ribHtml}
                            ${notesHtml}
                        `
                        : ``
                )
        }
    </div>

</div>
</body>
</html>`;

    printWindow.document.write(html);
    printWindow.document.close();

    printWindow.onload = function () {
        printWindow.focus();
        printWindow.print();
    };
}




// ------- Init -------
window.onload = function () {
    setTVA(0);
    switchListType("devis");
    initFirebase(); // üî• synchronisation avec Firestore au d√©marrage
};

</script>
</body>
</html>













































