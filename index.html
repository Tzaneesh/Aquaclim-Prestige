<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AquaClim Prestige - Devis & Factures</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

</head>

<body>
<div class="container">

  <!-- EN-TÃŠTE -->
  <header class="header">
    <div class="header-inner">
      <img src="logo.png" alt="AquaClim Prestige" class="header-logo" />
      <div>
        <h1>AquaClim Prestige</h1>
        <p class="subtitle">Entretien & DÃ©pannage - Climatisation & Piscine</p>
        <p class="contact">
          Le Blevennec LoÃ¯c â€“ 2 avenue Cauvin, 06100 Nice<br>
          TÃ©l : 06 03 53 77 73 â€“ Email : aquaclimprestige@gmail.com<br>
          SIRET : <strong>XXXXXXXXXXXXX</strong>
        </p>
      </div>
    </div>
  </header>

  <!-- ONGLET DEVIS / FACTURES -->
  <div class="top-nav no-print">
    <button id="tabDevis" class="btn tab-btn active" onclick="switchListType('devis')">ğŸ“„ Devis</button>
<button id="tabContrats" class="btn tab-btn" onclick="switchListType('contrat')">ğŸ“˜ Contrats</button>

    <button id="tabFactures" class="btn tab-btn" onclick="switchListType('facture')">ğŸ’° Factures</button>
  </div>

  <!-- LISTE DES DOCUMENTS -->
  <section id="listView">

<div class="actions no-print">
  <button id="createDevis" class="btn btn-primary" onclick="newDocument('devis')">â• Nouveau devis</button>

 <button id="createContract" class="btn btn-primary" onclick="newContract()">â• Nouveau contrat</button>


  <button id="createFacture" class="btn btn-success" onclick="newDocument('facture')">â• Nouvelle facture</button>

  <button class="btn btn-devis tarifs-button" onclick="openTarifsPanel()">ğŸ“‹ Tarifs prestations</button>
  <button
    class="btn btn-primary"
    type="button"
    onclick="openClientsListPopup()"
  >
    ğŸ‘¥ Clients
  </button>
</div>


    <!-- PANEL TARIFS -->
    <div id="tarifsPanel" class="card no-print hidden">
      <h2>Tarifs des prestations</h2>

      <!-- actions top -->
      <div class="tarifs-actions tarifs-actions-top">
        <button class="btn btn-secondary" onclick="closeTarifsPanel()">â† Retour</button>
        <button class="btn btn-primary" onclick="saveTarifsFromUI()">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-devis" onclick="openAddPrestationPopup()">â• Ajouter</button>
        <button class="btn btn-danger" onclick="resetTarifs()">ğŸ§¹ RÃ©initialiser</button>
      </div>

      <table class="documents-table">
        <thead>
          <tr>
            <th>Prestation</th>
            <th>Prix Particulier</th>
            <th>Prix Syndic</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tarifsTableBody"></tbody>
      </table>

      <div id="descEditor" class="desc-editor hidden">
        <h4>Texte dÃ©taillÃ© du modÃ¨le</h4>
        <label>Texte Particulier</label>
        <textarea id="descPartInput"></textarea>

        <label>Texte Syndic / Agence</label>
        <textarea id="descSynInput"></textarea>

        <div class="desc-editor-buttons">
          <button class="btn btn-primary btn-small" onclick="saveDescEditor()">Enregistrer</button>
          <button class="btn btn-secondary btn-small" onclick="closeDescEditor()">Fermer</button>
        </div>
      </div>

      <div class="tarifs-actions tarifs-actions-bottom">
        <button class="btn btn-secondary" onclick="closeTarifsPanel()">â† Retour</button>
        <button class="btn btn-primary" onclick="saveTarifsFromUI()">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-devis" onclick="openAddPrestationPopup()">â• Ajouter</button>
        <button class="btn btn-danger" onclick="resetTarifs()">ğŸ§¹ RÃ©initialiser</button>
      </div>
    </div>

    <!-- POPUP Ajouter prestation -->
    <div id="prestationPopup" class="popup-overlay hidden">
      <div class="popup">
        <h3 id="popupTitle">Nouvelle prestation</h3>

        <label>Nom de la prestation</label>
        <input type="text" id="popupName">

        <label>Prix Particulier</label>
        <input type="number" id="popupPricePart" step="0.01" oninput="onPopupPricePartChange()">

        <label>Prix Syndic</label>
        <input type="number" id="popupPriceSyn" step="0.01">

        <div class="popup-buttons">
          <button class="btn btn-primary" onclick="confirmPrestationPopup()">Valider</button>
          <button class="btn btn-secondary" onclick="closePrestationPopup()">Annuler</button>
        </div>
      </div>
    </div>

  <!-- TABLEAU DES DOCUMENTS -->
<div class="card">
  <div class="filters-row no-print">
    <span id="listTitle" class="list-title">Liste des devis</span>

    <!-- ğŸ” Recherche devis / factures -->

    <div class="doc-search-wrapper">
      <input
        type="text"
        id="docSearchInput"
        placeholder="Rechercher (nÂ°, client, objet...)"
        oninput="onDocumentsSearchChange()"
      />
    </div>

    <div id="yearFilterContainer" class="hidden">
      <label>AnnÃ©e</label>
      <select id="yearFilter" onchange="loadDocumentsList()">
        <option value="all">Toutes</option>
      </select>
    </div>

    <div id="exportContainer" class="hidden">
      <button class="btn btn-secondary btn-small" onclick="exportFacturesCSV()">ğŸ“¥ Exporter (CSV)</button>
    </div>
  </div>

    <div id="unpaidFilterContainer" class="hidden">
      <label style="font-size:14px;">
        <input type="checkbox" id="filterUnpaid" onchange="loadDocumentsList()">
        Afficher seulement les factures impayÃ©es
      </label>
    </div>


  <!-- Alerte contrats Ã  renouveler (visible uniquement sur lâ€™onglet Contrats) -->

  <div id="contractsAlert" class="contracts-alert no-print hidden"></div>
<div id="contractsFilterBar" class="no-print hidden" style="margin-bottom:10px;">
  <label style="font-size:14px;">
    <input type="checkbox" id="filterRenewal" onchange="loadContractsList()">
    Voir uniquement les contrats Ã  renouveler / terminÃ©s
  </label>
</div>

      <table class="documents-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>NumÃ©ro</th>
            <th>Client</th>
            <th>Date</th>
            <th>Montant</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody id="documentsTableBody">
          <tr><td colspan="7" class="no-docs-cell">Aucun document pour le moment</td></tr>
        </tbody>
      </table>
    </div>

  </section>

  <!-- FORMULAIRE DOCUMENT -->
  <section id="formView" class="hidden">

    <div class="actions no-print">
      <button class="btn btn-secondary" onclick="backToList()">â† Retour</button>
      <button class="btn action-button" onclick="saveDocument()">ğŸ’¾ Enregistrer</button>
      <button class="btn action-button" onclick="openPrintable()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn action-button" onclick="duplicateCurrent()">ğŸ§¾ Dupliquer</button>
      <button id="transformButton" class="btn action-button" style="display:none;" onclick="transformToInvoice()">ğŸ” Facture</button>
  <button id="contractFromDevisButton" class="btn action-button" style="display:none;" onclick="createContractFromDevis()">ğŸ“˜ Contrat</button>
      <button class="btn btn-danger" onclick="deleteCurrent()">ğŸ—‘ï¸ Supprimer</button>
    </div>

    <div class="card">
      <h2 id="formTitle">Nouveau document</h2>

      <!-- type document -->
      <div class="row">
        <div class="form-group">
         <label class="form-label">
  Type<span class="required-star">*</span>
</label>
          <select id="docType" onchange="updateDocType(); updateTransformButtonVisibility();">
            <option value="devis">Devis</option>
            <option value="facture">Facture</option>
          </select>
        </div>

        <div class="form-group">
          <label>NumÃ©ro</label>
          <input type="text" id="docNumber" readonly>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="date" id="docDate" onchange="onDocDateChange()">
        </div>

        <div class="form-group" id="validityDateGroup">
          <label>Valable jusquâ€™au</label>
          <input type="date" id="validityDate" onchange="onValidityChange()">
          <div id="devisStatusInfo" class="devis-status-info"></div>
        </div>
      </div>

      <div class="form-group">
       <label class="form-label">
  Objet <span class="required-star">*</span>
</label>
        <input type="text" id="docSubject" placeholder="Ex : Entretien piscine + clim â€“ Villa Martin">
      </div>

      <!-- type client -->
      <div class="form-group">
       <label class="form-label">
  Type de client <span class="required-star">*</span>
</label>
        <div class="client-type-row">

          <label class="client-type-option">
            <input type="radio" name="clientType" value="particulier" id="clientParticulier" onchange="selectClientType('particulier')">
            Particulier
          </label>

          <label class="client-type-option">
            <input type="radio" name="clientType" value="syndic" id="clientSyndic" onchange="selectClientType('syndic')">
            Syndic / Agence
          </label>

        </div>
      </div>

      <!-- INFORMATIONS CLIENT -->
<h3 class="section-title">Informations client</h3>

<div class="row">
  <div class="form-group" style="max-width: 140px;">
    <label>CivilitÃ©</label>
    <select id="clientCivility">
      <option value="">â€”</option>
      <option value="Monsieur">Monsieur</option>
      <option value="Madame">Madame</option>
      <option value="Monsieur et Madame">Monsieur et Madame</option>
    </select>
  </div>

  <div class="form-group">
   <label class="form-label">
  TNom ou SociÃ©tÃ© <span class="required-star">*</span>
</label>
    <input
      type="text"
      id="clientName"
      list="clientsList"
      autocomplete="off"
      required
      onchange="onClientNameChange()"
      onblur="onClientNameChange()"
    />
    <datalist id="clientsList"></datalist>
  </div>

  <!-- (le reste de tes champs Adresse / TÃ©lÃ©phone / Email ne bouge pas) -->
</div>


        <div class="form-group">
         <label class="form-label">
  Adresse <span class="required-star">*</span>
</label>
          <input type="text" id="clientAddress">
        </div>

        <div class="form-group">
          <label>TÃ©lÃ©phone</label>
          <input type="tel" id="clientPhone">
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="clientEmail">
        </div>
      </div>

      <!-- boutons clients -->
     <div class="row no-print" style="gap:10px; display:flex;">

  <!-- Ajouter client -->
  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="addCurrentClient()"
  >
    <span class="btn-icon-emoji">â•</span>
    <span>Ajouter ce client</span>
  </button>

  <!-- Voir liste clients -->
  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="openClientsListPopup()"
  >
    <span class="btn-icon-emoji">ğŸ“‹</span>
    <span>Voir liste clients</span>
  </button>

  <!-- Supprimer client -->
  <button
    type="button"
    class="btn btn-danger btn-small btn-icon"
    onclick="deleteCurrentClient()"
  >
    <span class="btn-icon-emoji">ğŸ—‘ï¸</span>
    <span>Supprimer ce client</span>
  </button>

</div>

      <!-- Lieu dâ€™intervention (si syndic/agence) -->
    <div id="siteBlock" class="row" style="display:none;">

  <div class="form-group" style="max-width: 150px;">
    <label>CivilitÃ© lieu</label>
    <select id="siteCivility" style="min-width: 250px;">

      <option value="">â€”</option>
      <option value="Chez Monsieur">Chez Monsieur</option>
      <option value="Chez Madame">Chez Madame</option>
      <option value="Appartement Monsieur">Appartement Monsieur</option>
      <option value="Appartement Madame">Appartement Madame</option>
      <option value="Villa Monsieur">Villa Monsieur</option>
      <option value="Villa Madame">Villa Madame</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label">
  Nom du client sur site <span class="required-star">*</span>
</label>
    <input type="text" id="siteName" placeholder="Ex : Mme Dupont Ã‰lise">
  </div>

  <div class="form-group">
<label class="form-label">
  Adresse du lieu d'intervention <span class="required-star">*</span>
</label>
    <input type="text" id="siteAddress" placeholder="Ex : RÃ©sidence Le Parc, BÃ¢t A, 14 rue ...">
  </div>

</div>


      <!-- PRESTATIONS -->
      <div class="prestations-section">
        <h3 class="section-title">Prestations</h3>

        <div id="prestationsContainer"></div>

        <button id="addPrestationBtn" class="btn action-button no-print" onclick="addPrestation()">
          â• Ajouter une prestation
        </button>
      </div>

      <!-- TOTAUX -->
      <div class="totals">

        <div class="total-line">
          <span>Sous-total HT :</span>
          <span id="subtotalHT">0,00 â‚¬</span>
        </div>

        <!-- RÃ©duction dans la grille -->
        <div class="totals-grid">
          <div class="form-group discount-group">
            <label>RÃ©duction</label>
            <div class="discount-row">
              <label class="discount-toggle">
                <input type="checkbox" id="discountEnabled" onchange="onDiscountToggle()">
                Appliquer une rÃ©duction
              </label>

              <input
                type="number"
                id="discountPercentInput"
                min="0"
                max="100"
                value="0"
                step="0.01"
                oninput="onDiscountPercentChange()"
                disabled
              >
              <span class="discount-percent-symbol">%</span>
            </div>
          </div>
        </div>

        <!-- ğŸ”» BLOC TVA DÃ‰PLACÃ‰ ICI, SOUS LA RÃ‰DUCTION -->
        <div class="form-group tva-group">
          <label>TVA</label>

          <div class="tva-options">
            <label>
              <input type="radio" name="tvaRadio" id="tva0" checked onchange="setTVA(0)"> 0 %
            </label>
            <label>
              <input type="radio" name="tvaRadio" id="tva20" onchange="setTVA(20)"> 20 %
            </label>
          </div>

          <div class="tva-rate-wrapper">
            <input type="number" id="tvaRate" value="0" step="0.01" readonly>
            <span class="tva-percent-symbol">%</span>
          </div>
        </div>

        <div id="discountLine" class="total-line" style="display:none;">
          <span id="discountLabel">RÃ©duction :</span>
          <span id="discountAmount">0,00 â‚¬</span>
        </div>

        <div class="total-line">
          <span>TVA :</span>
          <span id="tvaAmount">0,00 â‚¬</span>
        </div>

        <div class="total-line grand-total">
          <span id="totalLabel">NET Ã€ PAYER :</span>
          <span id="totalTTC">0,00 â‚¬</span>
        </div>

        <div class="tva-note" id="tvaNote">TVA non applicable, article 293 B du CGI.</div>
      </div>


      <!-- SECTION PAIEMENT (factures) -->
      <div class="form-group no-print" id="paymentSection">
        <label>RÃ¨glement</label>

        <div class="pay-line">
          <label><input type="radio" name="payMode" id="payNone" value="" checked onchange="onPayModeChange()"> Facture non rÃ©glÃ©e</label>
        </div>

        <div class="pay-line">
          <label><input type="radio" name="payMode" value="especes" id="payEspeces" onchange="onPayModeChange()"> EspÃ¨ces</label>
          <label><input type="radio" name="payMode" value="cb" id="payCB" onchange="onPayModeChange()"> Carte bancaire</label>
          <label><input type="radio" name="payMode" value="virement" id="payVirement" onchange="onPayModeChange()"> Virement</label>
          <label><input type="radio" name="payMode" value="cheque" id="payCheque" onchange="onPayModeChange()"> ChÃ¨que</label>
        </div>

        <div id="paymentDateWrapper" class="payment-date-wrapper">
          <label>Date de rÃ¨glement</label>
          <input type="date" id="paymentDate">
        </div>
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label>Notes / Conditions</label>
        <textarea id="notes" placeholder="Conditions de paiement, garanties, etc."></textarea>
      </div>

      <!-- ACTIONS BAS -->
    <div class="actions no-print">
      <button class="btn btn-secondary" onclick="backToList()">â† Retour</button>
      <button class="btn action-button" onclick="saveDocument()">ğŸ’¾ Enregistrer</button>
      <button class="btn action-button" onclick="openPrintable()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn action-button" onclick="duplicateCurrent()">ğŸ§¾ Dupliquer</button>
      <button id="transformButton" class="btn action-button" style="display:none;" onclick="transformToInvoice()">ğŸ” Facture</button>
  <button id="contractFromDevisButton" class="btn action-button" style="display:none;" onclick="createContractFromDevis()">ğŸ“˜ Contrat</button>
      <button class="btn btn-danger" onclick="deleteCurrent()">ğŸ—‘ï¸ Supprimer</button>
    </div>

    </div>
  </section>

<!-- ========================================================= -->
<!-- ===============   PAGE  CONTRAT PISCINE/SPA   ============ -->
<!-- ========================================================= -->

<section id="contractView" class="hidden">

  <div class="actions no-print" style="margin-bottom:20px;">
    <button class="btn btn-secondary" onclick="backToContracts()">â† Retour</button>
    <button class="btn btn-primary" onclick="saveContract()">ğŸ’¾ Enregistrer</button>
    <button class="btn btn-primary" onclick="openContractPDF()">ğŸ–¨ï¸ Imprimer</button>
<button class="btn action-button" onclick="transformContractToInvoice()">ğŸ” Transformer en facture</button>
<button class="btn btn-primary" type="button" onclick="openRenewPopup(currentContractId)">
  <span class="icon">ğŸ”</span> Renouveler
</button>
<button class="btn btn-primary" onclick="openContractSchedulePopup()">
  ğŸ“… Voir lâ€™Ã©chÃ©ancier
</button>
<button class="btn btn-danger" onclick="openResiliationPopup(currentContractId)">ğŸ”´ RÃ©silier</button>
<button class="btn btn-danger" onclick="deleteCurrentContract()">ğŸ—‘ï¸ Supprimer</button>
  </div>

  <div class="card">
    <div class="contract-header-blue">
  <h2>ğŸŸ¦ Contrat dâ€™entretien Piscine / Spa</h2>
</div>


    <!-- ================= INFOS CLIENT ================= -->

<h3 class="section-title">1. Informations client</h3>

<div class="row">
  <div class="form-group">
    <label>CivilitÃ©</label>
    <select id="ctClientCivility">
      <option value="">â€”</option>
      <option value="Monsieur">Monsieur</option>
      <option value="Madame">Madame</option>
      <option value="SociÃ©tÃ©">SociÃ©tÃ©</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label">
  Nom ou SociÃ©tÃ© <span class="required-star">*</span>
</label>
   <input
  type="text"
  id="ctClientName"
  list="clientsList"
  autocomplete="off"
  required
  onchange="onContractClientNameChange()"
  onblur="onContractClientNameChange()"
/>

  </div>

  <div class="form-group">
   <label class="form-label">
 Adresse <span class="required-star">*</span>
</label>
    <input type="text" id="ctClientAddress">
  </div>

  <div class="form-group">
    <label>TÃ©lÃ©phone</label>
    <input type="text" id="ctClientPhone">
  </div>

  <div class="form-group">
    <label>Email</label>
    <input type="email" id="ctClientEmail">
  </div>

  <div class="form-group">
    <label>RÃ©fÃ©rence contrat</label>
    <input type="text" id="ctReference">
  </div>
</div>

<!-- Boutons clients pour les contrats -->
<div class="row no-print" style="gap:10px; display:flex; margin-bottom:15px;">

  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="addCurrentClientFromContract()"
  >
    â• Ajouter ce client
  </button>

  <button
    type="button"
    class="btn btn-primary btn-small btn-icon"
    onclick="openClientsListPopup()"
  >
    ğŸ“‹ Voir liste clients
  </button>

  <button
    type="button"
    class="btn btn-danger btn-small btn-icon"
    onclick="deleteCurrentClientFromContract()"
  >
    ğŸ—‘ï¸ Supprimer ce client
  </button>

</div>




   <!-- ================= LIEU ================= -->
<div id="ctSiteSection">
  <h3 class="section-title">2. Lieu dâ€™intervention</h3>

  <div class="row">
    <div class="form-group">
      <label>CivilitÃ© du lieu</label>
      <select id="ctSiteCivility">
        <option value="">â€”</option>
        <option value="Chez Monsieur">Chez Monsieur</option>
        <option value="Chez Madame">Chez Madame</option>
        <option value="Appartement Monsieur">Appartement Monsieur</option>
        <option value="Appartement Madame">Appartement Madame</option>
        <option value="Villa Monsieur">Villa Monsieur</option>
        <option value="Villa Madame">Villa Madame</option>
        <option value="RÃ©sidence">RÃ©sidence</option>
      </select>
    </div>

    <div class="form-group">
     <label class="form-label">
  Nom sur place <span class="required-star">*</span>
</label>
      <input type="text" id="ctSiteName">
    </div>

    <div class="form-group">
      <label class="form-label">
 Adresse du bassin <span class="required-star">*</span>
</label>
      <input type="text" id="ctSiteAddress">
    </div>
  </div>
</div>



    <!-- ================= BASSIN ================= -->
    <h3 class="section-title">3. CaractÃ©ristiques du bassin</h3>

    <div class="row">
<div class="form-group">
  <label>Type de bassin</label>
  <select id="ctPoolType">
    <option value="piscine_chlore">ğŸŠ Piscine au chlore (traitement classique)</option>
    <option value="piscine_sel">ğŸŒŠ Piscine au sel (Ã©lectrolyseur)</option>
    <option value="spa">ğŸ› Spa / Jacuzzi</option>
  </select>
</div>


 <div class="form-group">
  <label>Traitement / Ã©quipement principal</label>
  <select id="ctEquipment">
    <option value="">â€”</option>
    <option value="Traitement manuel">Traitement manuel</option>
    <option value="Ã‰lectrolyseur au sel">Ã‰lectrolyseur au sel</option>
    <option value="RÃ©gulation automatique pH / redox">RÃ©gulation automatique pH / redox</option>
    <option value="Autre (prÃ©cisÃ© en observation)">Autre (prÃ©cisÃ© en observation)</option>
  </select>
</div>


<div class="form-group">
  <label>Volume approximatif (mÂ³)</label>
  <input type="text" id="ctVolume">
</div>

      <div class="form-group">
        <label>ParticularitÃ©s</label>
        <textarea id="ctNotes" placeholder="AccÃ¨s difficile, horaires, animauxâ€¦"></textarea>
      </div>
    </div>


    <!-- ================= FRÃ‰QUENCE ================= -->
    <h3 class="section-title">4. FrÃ©quence & planification</h3>

    <div class="row">
<div class="form-group">
        <label for="ctStartDate">
 Type de client <span class="required-star">*</span>
</label>
  <div class="client-type-row">
    <label class="client-type-option">
      <input type="radio" name="ctClientTypeChoice" value="particulier" id="ctClientParticulier" checked>
      Particulier
    </label>
    <label class="client-type-option">
      <input type="radio" name="ctClientTypeChoice" value="syndic" id="ctClientSyndic">
      Syndic / Agence
    </label>
  </div>
  <!-- Valeur utilisÃ©e par le JS (comme avant) -->
  <input type="hidden" id="ctClientType" value="particulier">
</div>


 <div class="form-group">
  <label>Prestation principale (auto pour le tarif)</label>
  <select id="ctMainService" disabled>
    <option value="piscine_chlore">Piscine (Chlore)</option>
    <option value="piscine_sel">Piscine (Sel)</option>
    <option value="entretien_jacuzzi">Spa / Jacuzzi</option>
  </select>
</div>


      <div class="form-group">
        <label>Mode de passages</label>
        <select id="ctMode">
          <option value="standard">Standard : 1/mois hiver â€“ 2/mois Ã©tÃ©</option>
          <option value="intensif">Intensif : 2/mois hiver â€“ 4/mois Ã©tÃ©</option>
          <option value="custom">PersonnalisÃ©</option>
        </select>
      </div>

<div class="form-group">
  <label>Passages hiver (nov â†’ avr)</label>
  <select id="ctPassHiver">
    <option value="0">0 â€“ Sur demande</option>
    <option value="1">1 passage / mois</option>
    <option value="2">2 passages / mois</option>
    <option value="4">4 passages / mois</option>
  </select>
</div>

<div class="form-group">
  <label>Passages Ã©tÃ© (mai â†’ oct)</label>
  <select id="ctPassEte">
    <option value="0">0 â€“ Sur demande</option>
    <option value="1">1 passage / mois</option>
    <option value="2" selected>2 passages / mois</option>
    <option value="4">4 passages / mois</option>
  </select>
</div>

    </div>

    <div class="row">
      <div class="form-group">
        <label for="ctStartDate">
  DÃ©but du contrat <span class="required-star">*</span>
</label>

        <input type="date" id="ctStartDate">
      </div>

 <div class="form-group">
  <label>DurÃ©e du contrat</label>
<select id="ctDuration" class="form-select">
  <option value="4">4 mois â€“ Saison Ã©tÃ© (juin â†’ septembre)</option>
  <option value="5">5 mois â€“ Saison Ã©tendue</option>
  <option value="6">6 mois â€“ Saison longue (mai â†’ octobre)</option>
  <option value="12">12 mois â€“ Annuel</option>
</select>

</div>


      <div class="form-group">
        <label>Fin du contrat (auto)</label>
        <input type="text" id="ctEndDate" readonly>
      </div>

      <div class="form-group">
        <label>PÃ©riode couverte</label>
        <input type="text" id="ctPeriod" readonly>
      </div>

<div class="form-group">
  <label>Total passages (auto)</label>

  <input type="text" id="ctTotalPassages" readonly>

  <div id="ctRecapSummary" class="ct-recap-summary"></div>
  <div id="ctWarning" class="ct-warning hidden"></div>
</div>

    </div>


      <!-- ================= TARIFS ================= -->
    <h3 class="section-title">5. Tarifs & calcul automatique</h3>

    <div class="row">
      <div class="form-group">
        <label>Prix unitaire (auto)</label>
        <input type="text" id="ctUnitPrice" readonly>
      </div>

      <div class="form-group">
        <label>Montant total HT</label>
        <input type="text" id="ctTotalHT" readonly>
      </div>
    </div>
<div class="row">
  <div class="form-group">
  <label for="ctBillingMode">
  Mode de facturation <span class="required-star">*</span>
</label>

    <select id="ctBillingMode">
      <option value="mensuel">Mensuel</option>
      <option value="trimestriel">Trimestriel</option>
      <option value="semestriel">Semestriel</option>
      <option value="annuel">Annuel (forfait)</option>
    </select>
  </div>
</div>

<div class="row">
  <div class="form-group">
    <label>Options dâ€™usage</label>
    <div class="options-box">
      <label class="option-item">
        <input type="checkbox" id="ctAirbnb">
        <span>Usage location saisonniÃ¨re / Airbnb (majoration +20 %)</span>
      </label>
    </div>
  </div>
</div>

<div class="row">
  <div class="form-group">
    <label>Options forfaitaires</label>

    <div class="options-box">
      <label class="option-item">
        <input type="checkbox" id="ctIncludeOpening">
        <span>Mise en service de la piscine avant la saison estivale</span>
      </label>

      <label class="option-item">
        <input type="checkbox" id="ctIncludeWinter">
        <span>Hivernage</span>
      </label>
    </div>

  </div>
</div>

<div class="contract-summary">
  <h4>RÃ©capitulatif</h4>
  <p><strong>Visites :</strong> <span id="ctRecapPassages">0</span></p>
  <p><strong>Prix unitaire :</strong> <span id="ctRecapPrice">0 â‚¬</span></p>
  <p><strong>Total contrat :</strong> <span id="ctRecapTotal">0 â‚¬</span></p>
</div>

<div class="contract-tva">
  <label>TVA </label>
  <div class="tva-options">
    <label>
      <input
        type="radio"
        name="contractTva"
        id="ctTva0"
        value="0"
        checked
        onchange="setTVA(0)"
      >
      0 %
    </label>

    <label>
      <input
        type="radio"
        name="contractTva"
        id="ctTva20"
        value="20"
        onchange="setTVA(20)"
      >
      20 %
    </label>
  </div>
</div>


    <!-- ACTIONS BAS CONTRAT -->
   <div class="actions no-print" style="margin-bottom:20px;">
    <button class="btn btn-secondary" onclick="backToContracts()">â† Retour</button>
    <button class="btn btn-primary" onclick="saveContract()">ğŸ’¾ Enregistrer</button>
    <button class="btn btn-primary" onclick="openContractPDF()">ğŸ–¨ï¸ Imprimer</button>
<button class="btn action-button" onclick="transformContractToInvoice()">ğŸ” Transformer en facture</button>
<button class="btn btn-primary" type="button" onclick="openRenewPopup(currentContractId)">
  <span class="icon">ğŸ”</span> Renouveler
</button>
<button class="btn btn-primary" onclick="openContractSchedulePopup()">
  ğŸ“… Voir lâ€™Ã©chÃ©ancier
</button>


<button class="btn btn-danger" onclick="openResiliationPopup(currentContractId)">ğŸ”´ RÃ©silier</button>


    <button class="btn btn-danger" onclick="deleteCurrentContract()">ğŸ—‘ï¸ Supprimer</button>
  </div>

  </div> <!-- fin .card -->

</section> <!-- fin #contractView -->



  <!-- ================= POPUP CONFIRM CUSTOM ================= -->
  <div id="confirmOverlay" ...

  <div id="confirmOverlay" class="confirm-overlay hidden">
    <div class="confirm-box">

      <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
      <h3 class="confirm-title" id="confirmTitle"></h3>
      <p class="confirm-message" id="confirmMessage"></p>

      <div class="confirm-buttons">
        <button id="confirmCancel" class="btn btn-secondary" type="button">Annuler</button>
        <button id="confirmOk" class="btn btn-danger" type="button">OK</button>
      </div>
    </div>
  </div>


<div id="renewPopup" class="popup hidden">
  <h3>Renouvellement du contrat</h3>
  <p>Souhaites-tu renouveler ce contrat pour une nouvelle pÃ©riode ?</p>

  <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
    <button class="btn btn-secondary" onclick="closeRenewPopup()">Annuler</button>
    <button class="btn btn-primary" onclick="confirmRenewPopup()">Renouveler</button>
  </div>
</div>
<div id="contractSchedulePopup" class="popup-overlay hidden">
  <div class="popup">
    <h3>Ã‰chÃ©ancier du contrat</h3>
    <p id="contractScheduleTitle" class="schedule-contract-title"></p>
    <p id="contractSchedulePeriod" class="schedule-contract-period"></p>

    <div id="contractScheduleContent"></div>

    <div class="popup-buttons">
      <button class="btn btn-light" onclick="closeContractSchedulePopup()">Fermer</button>
    </div>
  </div>
</div>




  <!-- ================= POPUP RÃ‰SILIATION CONTRAT ================= -->

<div id="resiliationPopup" class="popup hidden">
  <h3>RÃ©siliation du contrat</h3>

<label for="resiliationWho">Qui rÃ©silie ?</label>
  <select id="resiliationWho">
    <option value="client">Le client</option>
    <option value="prestataire">AquaClim Prestige</option>
  </select>

  <label for="resiliationDate" style="margin-top:8px;">Date de rÃ©ception du courrier recommandÃ©</label>
  <input
    type="date"
    id="resiliationDate"
  />
  <p class="resiliation-note">
    Laisse vide pour utiliser la date d'aujourd'hui.
  </p>

  <label for="resiliationMotif" style="margin-top:8px;">Motif de rÃ©siliation</label>
  <textarea
    id="resiliationMotif"
    placeholder="Ex : Vente du bien, dÃ©part, changement de prestataire, impayÃ©s rÃ©pÃ©tÃ©sâ€¦"
    rows="3"
  ></textarea>

  <p class="resiliation-note">
    La rÃ©siliation prendra effet aprÃ¨s rÃ©ception du courrier recommandÃ© et Ã©mission de la facture de clÃ´ture.
  </p>

  <div class="popup-buttons">
    <button type="button" class="btn btn-secondary" onclick="closeResiliationPopup()">Annuler</button>
    <button type="button" class="btn btn-danger" onclick="confirmResiliationPopup()">
      Confirmer la rÃ©siliation
    </button>
  </div>
</div>
  

  <!-- ================= POPUP LISTE CLIENTS ================= -->

  <div id="clientsPopup" class="popup-overlay hidden">
    <div class="popup">

      <h3>Liste des clients</h3>

      <!-- ğŸ” Barre de recherche -->
      <input
        type="text"
        id="clientSearchInput"
        placeholder="Rechercher un client..."
        oninput="filterClientsList()"
        style="width:100%; padding:8px; margin-bottom:12px; border-radius:6px; border:1px solid #ccc;"
      />

      <!-- ğŸ“‹ Liste clients -->
      <div id="clientsListContainer" class="client-list-box"></div>
<!-- Pagination -->
<div id="clientsPagination" class="clients-pagination">
  <button class="btn btn-secondary btn-small" type="button" onclick="prevClientsPage()">â—€</button>
  <span id="clientsPageInfo">Page 1 / 1</span>
  <button class="btn btn-secondary btn-small" type="button" onclick="nextClientsPage()">â–¶</button>
</div>
      <!-- âœï¸ Formulaire dâ€™Ã©dition -->
      <div id="editClientForm" class="hidden" style="margin-top:15px;">
        <h4>Modifier le client</h4>

             <label for="ctStartDate">
 Nom <span class="required-star">*</span>
</label>
        <input type="text" id="editClientName">

             <label for="ctStartDate">
  Adresse <span class="required-star">*</span>
</label>
        <input type="text" id="editClientAddress">

        <label>TÃ©lÃ©phone</label>
        <input type="text" id="editClientPhone">

        <label>Email</label>
        <input type="text" id="editClientEmail">

        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary btn-small" onclick="saveEditedClient()">ğŸ’¾ Enregistrer</button>
          <button class="btn btn-secondary btn-small" onclick="cancelEditClient()">Annuler</button>
        </div>
      </div>

<!-- ğŸ“¤ Export CSV + Fermer -->
<div class="popup-buttons clients-footer">
  <div class="clients-footer-left">
    <button class="btn btn-primary btn-small btn-icon" type="button" onclick="openAddClientFromList()">
  <span class="btn-icon-emoji">â•</span>
  <span>Ajouter un client</span>
</button>

  </div>
  <div class="clients-footer-right">
    <button class="btn btn-primary btn-small" type="button" onclick="exportClientsCSV()">
      ğŸ“¤ Export CSV
    </button>
    <button class="btn btn-secondary btn-small" type="button" onclick="closeClientsListPopup()">
      Fermer
    </button>
  </div>
</div>


  </div> <!-- .popup -->
</div> <!-- #clientsPopup -->

</div> <!-- FIN container -->

<!-- App JS -->
<script src="app.js"></script>
</body>
</html>




